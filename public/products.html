<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="csrf-token" content="your-csrf-token-here">
  <title>Products | Core Insight Marketplace</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <!-- Modern font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-dark: #0f172a;
      --secondary-dark: #1e293b;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-gold: #f59e0b;
      --accent-gold-dark: #d97706;
      --text-light: #f8fafc;
      --text-gray: #94a3b8;
      --text-muted: #64748b;
      --card-bg: #1e293b;
      --card-bg-hover: #2d3748;
      --border: #334155;
      --border-light: #475569;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --digital: #8b5cf6;
      --physical: #06b6d4;
      --affiliate: #10b981;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      background: var(--primary-dark);
      color: var(--text-light);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    header {
      height: 70px;
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 28px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--accent), var(--digital));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--text-light), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    nav {
      display: flex;
      gap: 28px;
      align-items: center;
    }

    nav a {
      color: var(--text-gray);
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      padding: 8px 4px;
      position: relative;
      transition: var(--transition);
    }

    nav a:hover {
      color: var(--text-light);
    }

    nav a.active {
      color: var(--accent);
    }

    nav a.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .auth-btn {
      padding: 10px 22px;
      border-radius: var(--radius-md);
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: var(--transition);
      border: none;
    }

    #loginOpen {
      background: transparent;
      color: var(--text-gray);
      border: 1px solid var(--border);
    }

    #loginOpen:hover {
      background: var(--card-bg-hover);
      color: var(--text-light);
    }

    #signupOpen {
      background: var(--accent);
      color: white;
    }

    #signupOpen:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    main {
      padding-top: calc(70px + 32px);
      max-width: 1280px;
      margin: 0 auto;
      padding-left: 28px;
      padding-right: 28px;
    }

    /* Hero */
    .hero {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 2rem;
      margin-bottom: 32px;
    }

    .hero .left {
      flex: 1;
    }

    .hero h1 {
      font-size: 2.5rem;
      margin-bottom: 12px;
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-light);
    }

    .hero p {
      color: var(--text-gray);
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
      max-width: 600px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      margin: 32px 0;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
    }

    .search-input {
      padding: 12px 20px 12px 44px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--primary-dark);
      color: var(--text-light);
      width: 300px;
      font-size: 14px;
      transition: var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 16px center;
      background-size: 20px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .select, .btn {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--primary-dark);
      color: var(--text-light);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }

    .select:focus, .btn:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn.primary {
      background: var(--accent);
      color: white;
      border: none;
    }

    .btn.primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .view-toggle {
      margin-left: auto;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .become-seller {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 12px 24px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: var(--transition);
    }

    .become-seller:hover {
      background: var(--card-bg-hover);
      border-color: var(--accent);
    }

    /* Currency Selector */
    .currency-selector {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--primary-dark);
      border-radius: var(--radius-md);
      padding: 12px 20px;
      border: 1px solid var(--border);
    }

    .currency-selector label {
      color: var(--text-gray);
      font-size: 14px;
      white-space: nowrap;
    }

    .currency-selector select {
      background: transparent;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      outline: none;
      font-weight: 500;
    }

    /* Product Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }

    /* Modern Product Card */
    .product-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      position: relative;
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--accent);
    }

    /* Product Type Badge */
    .product-badge {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 2;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: white;
    }

    .badge-digital {
      background: var(--digital);
    }

    .badge-physical {
      background: var(--physical);
    }

    .badge-affiliate {
      background: var(--affiliate);
    }

    /* Payment Method Badge */
    .payment-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 2;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    /* Delivery Method Badge */
    .delivery-badge {
      position: absolute;
      top: 46px;
      right: 16px;
      z-index: 2;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .card-media {
      height: 220px;
      background: var(--secondary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .card-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .product-card:hover .card-media img {
      transform: scale(1.05);
    }

    /* Thumbnails */
    .thumbs {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 3;
    }

    .thumbs img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      opacity: 0.7;
    }

    .thumbs img:hover,
    .thumbs img.active {
      border-color: var(--accent);
      opacity: 1;
    }

    /* Favorite Button */
    .favorite-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-gray);
      transition: var(--transition);
      z-index: 2;
    }

    .favorite-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: var(--danger);
    }

    .favorite-btn.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--danger);
      color: var(--danger);
    }

    /* Delete Button - Only for owner/admin */
    .delete-btn {
      position: absolute;
      top: 64px;
      right: 16px;
      background: rgba(239, 68, 68, 0.1);
      backdrop-filter: blur(4px);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-gray);
      transition: var(--transition);
      z-index: 2;
      display: none; /* Hidden by default */
    }

    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--danger);
      color: var(--danger);
    }

    .product-card.is-owner .delete-btn {
      display: flex; /* Show for owner */
    }

    /* Card Body */
    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card-body h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-light);
    }

    .meta {
      color: var(--text-gray);
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .seller-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      color: var(--text-gray);
      font-size: 13px;
    }

    .seller-info i {
      color: var(--accent);
    }

    /* Product Details */
    .product-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-gray);
    }

    .detail-item i {
      color: var(--accent);
      width: 16px;
    }

    .detail-item strong {
      color: var(--text-light);
      font-weight: 500;
    }

    /* Price and Actions */
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .price {
      color: var(--accent);
      font-weight: 700;
      font-size: 18px;
    }

    .price .currency {
      font-size: 12px;
      color: var(--text-gray);
      font-weight: 500;
    }

    .rating {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }

    .rating-stars {
      color: var(--warning);
      font-size: 12px;
    }

    .rating-count {
      color: var(--text-gray);
      font-size: 12px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .small-btn {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .small-btn:hover {
      background: var(--card-bg-hover);
      border-color: var(--border-light);
    }

    .small-btn.primary {
      background: var(--accent);
      color: white;
      border: none;
    }

    .small-btn.primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .small-btn.success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border-color: var(--success);
    }

    .small-btn.success:hover {
      background: rgba(16, 185, 129, 0.2);
      transform: translateY(-1px);
    }

    .small-btn.danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: var(--danger);
    }

    .small-btn.danger:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }

    /* Owner Controls */
    .owner-controls {
      display: none;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .product-card.is-owner .owner-controls {
      display: flex;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 20px;
      border-radius: var(--radius-md);
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 9999;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast i {
      font-size: 20px;
    }

    .toast.success i {
      color: var(--success);
    }

    .toast.info i {
      color: var(--accent);
    }

    .toast.warning i {
      color: var(--warning);
    }

    .toast.danger i {
      color: var(--danger);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 4px;
    }

    .toast-message {
      color: var(--text-gray);
      font-size: 13px;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-gray);
      cursor: pointer;
      padding: 4px;
    }

    .toast-close:hover {
      color: var(--text-light);
    }

    /* ================= PROFESSIONAL SELLER FORM ================= */
    .upload-section {
      background: var(--card-bg);
      padding: 32px;
      border-radius: var(--radius-lg);
      margin-top: 32px;
      border: 1px solid var(--border);
      display: none;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .upload-section.active {
      display: block;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .form-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .form-header h3 i {
      color: var(--accent);
    }

    .close-form {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-gray);
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .close-form:hover {
      background: var(--card-bg-hover);
      color: var(--text-light);
    }

    .upload-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 32px;
    }

    @media (max-width: 1024px) {
      .upload-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }

    /* Form Styling */
    .form-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .form-section {
      background: rgba(15, 23, 42, 0.5);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
    }

    .form-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .form-section-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
    }

    .form-section-header i {
      color: var(--accent);
      width: 32px;
      height: 32px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
    }

    .form-label .required {
      color: var(--danger);
      margin-left: 4px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--primary-dark);
      color: var(--text-light);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    .form-help {
      display: block;
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 8px 0;
    }

    .form-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .form-checkbox span {
      color: var(--text-light);
      font-size: 14px;
    }

    /* Payment Method Note for Physical Products */
    .payment-method-note {
      background: rgba(16, 185, 129, 0.1);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      margin-top: 16px;
    }

    .payment-method-note p {
      margin: 0;
      color: var(--success);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .payment-method-note i {
      color: var(--success);
    }

    /* Payment Provider Section */
    .payment-provider-section {
      background: rgba(59, 130, 246, 0.05);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      margin: 20px 0;
    }

    .payment-provider-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .payment-provider-header i {
      color: var(--accent);
      font-size: 20px;
    }

    .payment-provider-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--accent);
    }

    .provider-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .provider-option {
      background: var(--primary-dark);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 20px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 12px;
    }

    .provider-option:hover {
      border-color: var(--accent);
    }

    .provider-option.selected {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .provider-option i {
      font-size: 32px;
      color: var(--accent);
    }

    .provider-option h5 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-light);
    }

    .provider-option p {
      margin: 0;
      color: var(--text-gray);
      font-size: 13px;
      line-height: 1.4;
    }

    /* Commission Display */
    .commission-card {
      background: rgba(16, 185, 129, 0.1);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      margin-top: 24px;
    }

    .commission-card h5 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .commission-structure {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    .commission-item {
      background: var(--primary-dark);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .commission-item i {
      color: var(--success);
      font-size: 20px;
    }

    .commission-item span {
      font-size: 14px;
      color: var(--text-light);
    }

    .commission-item strong {
      color: var(--success);
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      gap: 16px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .form-btn {
      padding: 14px 28px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    .form-btn.primary {
      flex: 2;
      background: var(--accent);
      color: white;
    }

    .form-btn.primary:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .form-btn.secondary {
      flex: 1;
      background: transparent;
      color: var(--text-gray);
      border: 1px solid var(--border);
    }

    .form-btn.secondary:hover {
      background: var(--card-bg-hover);
      color: var(--text-light);
    }

    /* Form Validation Messages */
    .form-error {
      display: none;
      margin-top: 6px;
      padding: 8px 12px;
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid var(--danger);
      border-radius: var(--radius-sm);
      color: var(--danger);
      font-size: 13px;
      line-height: 1.4;
    }

    .form-error.show {
      display: block;
    }

    .form-success {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid var(--success);
      border-radius: var(--radius-md);
      color: var(--success);
      font-size: 14px;
      line-height: 1.6;
    }

    .form-success.show {
      display: block;
    }

    /* File Upload */
    .file-upload {
      position: relative;
      overflow: hidden;
    }

    .file-upload input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-upload-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: var(--primary-dark);
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-gray);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-upload-label:hover {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.05);
    }

    .file-upload-label i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--accent);
    }

    .file-upload-label span {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .file-upload-label small {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Conditional Sections */
    .conditional-section {
      display: none;
    }

    .conditional-section.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Sidebar Tips */
    .form-sidebar {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .info-card {
      background: rgba(15, 23, 42, 0.5);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border);
    }

    .info-card h4 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-card h4 i {
      color: var(--accent);
    }

    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .info-list li {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      color: var(--text-gray);
      font-size: 14px;
      line-height: 1.5;
    }

    .info-list li i {
      color: var(--accent);
      margin-top: 2px;
      flex-shrink: 0;
    }

    .info-list li strong {
      color: var(--text-light);
      font-weight: 600;
    }

    /* ================= END PROFESSIONAL SELLER FORM ================= */

    /* ================= REVIEWS SECTION ================= */
    .reviews-section {
      margin-top: 40px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .reviews-list {
      margin-top: 20px;
    }

    .review-item {
      padding: 20px;
      margin-bottom: 16px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .review-item:hover {
      border-color: var(--border-light);
    }

    .review-item strong {
      display: block;
      color: var(--accent);
      margin-bottom: 8px;
      font-size: 15px;
    }

    .review-item p {
      margin: 8px 0;
      color: var(--text-light);
      line-height: 1.6;
    }

    .review-item small {
      color: var(--text-gray);
      font-size: 13px;
    }

    .average-rating {
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--accent);
      font-size: 16px;
    }

    .review-form {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius-lg);
      margin-top: 24px;
      border: 1px solid var(--border);
    }

    .review-form h4 {
      margin-top: 0;
      margin-bottom: 16px;
      color: var(--accent);
    }

    .review-form textarea {
      width: 100%;
      min-height: 100px;
      margin: 12px 0;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--primary-dark);
      color: var(--text-light);
      font-family: inherit;
      resize: vertical;
    }

    .review-form select {
      padding: 10px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--primary-dark);
      color: var(--text-light);
      margin-bottom: 12px;
      width: 200px;
    }

    .review-form button {
      padding: 10px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
    }

    .review-form button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .form-message {
      margin-top: 12px;
      padding: 10px;
      border-radius: var(--radius-md);
      font-size: 14px;
    }

    .hidden {
      display: none;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal.open {
      display: flex;
    }

    .modal-card {
      background: var(--card-bg);
      padding: 28px;
      border-radius: var(--radius-xl);
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border);
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-x {
      float: right;
      color: var(--text-gray);
      cursor: pointer;
      font-weight: 700;
      font-size: 20px;
      transition: var(--transition);
      padding: 4px;
    }

    .close-x:hover {
      color: var(--text-light);
    }

    /* Skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--card-bg) 25%, var(--card-bg-hover) 50%, var(--card-bg) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    .skeleton-text {
      height: 16px;
      margin-bottom: 8px;
    }

    .skeleton-text.short {
      width: 60%;
    }

    .skeleton-text.price {
      width: 40%;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Empty State */
    #noProducts {
      display: none;
      color: var(--text-gray);
      margin-top: 28px;
      text-align: center;
      padding: 48px;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
    }

    #noProducts i {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--text-muted);
    }

    #noProducts h3 {
      margin-bottom: 8px;
      color: var(--text-light);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .hero {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-input {
        width: 100%;
      }
      
      .view-toggle {
        width: 100%;
        justify-content: space-between;
        margin-top: 12px;
      }
      
      main {
        padding-left: 20px;
        padding-right: 20px;
      }
      
      nav {
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }
      
      header {
        padding: 0 20px;
      }
      
      .hero h1 {
        font-size: 2rem;
      }
      
      nav {
        display: none;
      }
    }

    @media (max-width: 480px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .controls {
        padding: 16px;
      }
      
      .currency-selector {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>

  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-store"></i></div>
        <div class="logo-text">Core Insight</div>
      </div>
    </div>

    <nav>
      <a href="index.html">Home</a>
      <a href="knowledge-hub.html">Knowledge Hub</a>
      <a href="services.html">Services</a>
      <a href="courses.html">Courses</a>
      <a href="products.html" class="active">Products</a>
    </nav>

    <div class="header-actions">
      <div id="headerAuthButtons">
        <button id="loginOpen" class="auth-btn">Login</button>
        <button id="signupOpen" class="auth-btn signup">Sign Up</button>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="left">
        <h1>Discover Digital & Physical Products</h1>
        <p>Shop from creators worldwide or start selling your own products — no inventory needed.</p>
      </div>
      <div class="right" style="min-width:260px;text-align:right">
        <div class="view-toggle">
          <span style="color:var(--text-gray)">Viewing as <strong id="browseModeText" style="color:var(--accent)">Buyer</strong></span>
          <button id="becomeSeller" class="become-seller">Become a Seller</button>
        </div>
      </div>
    </section>

    <section class="controls">
      <input id="searchInput" class="search-input" placeholder="Search products, categories..." />
      <select id="filterType" class="select">
        <option value="">All types</option>
        <option value="digital">Digital</option>
        <option value="physical">Physical</option>
        <option value="affiliate">Affiliate</option>
      </select>
      <select id="filterCategory" class="select">
        <option value="">All categories</option>
      </select>
      <select id="sortSelect" class="select">
        <option value="newest">Newest</option>
        <option value="affordable">Most affordable</option>
        <option value="rated">Highest rated</option>
        <option value="favorites">Most favorited</option>
      </select>
      
      <div class="currency-selector">
        <label for="currencyHeader">Currency:</label>
        <select id="currencyHeader" title="Display currency">
          <option value="USD">USD</option>
          <option value="NGN">NGN</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="KES">KES</option>
          <option value="GHS">GHS</option>
          <option value="ZAR">ZAR</option>
        </select>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="btn primary">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </button>
      </div>
    </section>

    <!-- ================= PROFESSIONAL SELLER FORM ================= -->
    <section id="sellerView" class="upload-section" aria-hidden="true">
      <div class="form-header">
        <h3><i class="fas fa-upload"></i> List Your Product</h3>
        <button id="cancelSeller" class="close-form" title="Close form">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="upload-grid">
        <!-- Main Form -->
        <div class="form-container">
          <!-- Basic Information -->
          <div class="form-section">
            <div class="form-section-header">
              <i class="fas fa-info-circle"></i>
              <h4>Basic Information</h4>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Product Name <span class="required">*</span></label>
                <input type="text" id="p_title" class="form-input" placeholder="e.g. Premium Photoshop Brushes" required />
                <div id="p_title_error" class="form-error"></div>
                <span class="form-help">Choose a clear, descriptive name</span>
              </div>
              
              <div class="form-group">
                <label class="form-label">Product Type <span class="required">*</span></label>
                <select id="p_type" class="form-select" required>
                  <option value="">Select product type</option>
                  <option value="digital">Digital Product</option>
                  <option value="physical">Physical Product</option>
                  <option value="affiliate">Affiliate Link</option>
                </select>
                <div id="p_type_error" class="form-error"></div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Description <span class="required">*</span></label>
              <textarea id="p_description" class="form-textarea" rows="4" placeholder="Describe your product features, benefits..." required></textarea>
              <div id="p_description_error" class="form-error"></div>
              <span class="form-help">Be detailed about what customers will receive</span>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Category <span class="required">*</span></label>
                <div style="display: flex; gap: 12px; align-items: flex-end;">
                  <select id="p_category_select" class="form-select" style="flex: 1;">
                    <option value="">Select existing category</option>
                  </select>
                  <span style="color: var(--text-muted); margin: 0 8px;">or</span>
                  <input type="text" id="p_category_new" class="form-input" placeholder="Create new category" style="flex: 1;" />
                </div>
                <div id="p_category_error" class="form-error"></div>
              </div>
              
              <div class="form-group">
                <label class="form-label">Price (USD) <span class="required">*</span></label>
                <input type="number" id="p_price" class="form-input" step="0.01" min="0.01" placeholder="0.00" required />
                <div id="p_price_error" class="form-error"></div>
                <span class="form-help">Enter price in US dollars</span>
              </div>
            </div>
          </div>

          <!-- Product Type Specific Sections -->
          <div id="digitalBlock" class="conditional-section">
            <div class="form-section">
              <div class="form-section-header">
                <i class="fas fa-file-archive"></i>
                <h4>Digital Product Details</h4>
              </div>
              
              <div class="form-checkbox">
                <input type="checkbox" id="useAffiliate" />
                <span>This product uses an external affiliate link</span>
              </div>
              
              <div id="affiliateFields" class="conditional-section" style="margin-top: 20px;">
                <div class="form-group">
                  <label class="form-label">Affiliate URL <span class="required">*</span></label>
                  <input type="text" id="p_affiliate" class="form-input" placeholder="https://affiliate.example.com/track/..." />
                  <div id="p_affiliate_error" class="form-error"></div>
                </div>
              </div>
              
              <div id="digitalUpload" class="conditional-section show" style="margin-top: 20px;">
                <label class="form-label">Product File <span class="required">*</span></label>
                <div class="file-upload">
                  <input type="file" id="p_file" accept=".zip,.pdf,.mp3,.mp4,.epub,.docx" required />
                  <label for="p_file" class="file-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Click to upload digital file</span>
                    <small>Max file size: 100MB • Supported: ZIP, PDF, MP3, MP4, EPUB, DOCX</small>
                  </label>
                </div>
                <div id="p_file_error" class="form-error"></div>
              </div>
            </div>
          </div>

          <div id="physicalBlock" class="conditional-section">
            <div class="form-section">
              <div class="form-section-header">
                <i class="fas fa-shipping-fast"></i>
                <h4>Physical Product Details</h4>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Delivery Method</label>
                  <select id="p_deliveryType" class="form-select">
                    <option value="pickup">Customer Pickup</option>
                    <option value="delivery">Home Delivery</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Payment Option</label>
                  <select id="p_paymentOption" class="form-select">
                    <option value="pay_before">Pay Before Delivery</option>
                    <option value="pay_on_delivery">Pay On Delivery</option>
                    <option value="both">Both Options Available</option>
                  </select>
                </div>
              </div>
              
              <div id="deliveryExtra" class="conditional-section" style="margin-top: 20px;">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Delivery Locations</label>
                    <input type="text" id="p_deliveryLocations" class="form-input" placeholder="e.g. USA, UK, Nigeria" />
                    <span class="form-help">Comma separated countries or cities</span>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Delivery Fee (USD)</label>
                    <input type="number" id="p_deliveryFee" class="form-input" step="0.01" min="0" placeholder="0.00" />
                    <span class="form-help">Additional delivery charge</span>
                  </div>
                </div>
              </div>
              
              <!-- Payment Method Note for Physical Products -->
              <div class="payment-method-note">
                <p><i class="fas fa-money-bill-wave"></i> <strong>Note:</strong> Physical products default to "Pay on Delivery" option</p>
              </div>
            </div>
          </div>

          <!-- Payment Account Setup -->
          <div class="payment-provider-section">
            <div class="payment-provider-header">
              <i class="fas fa-credit-card"></i>
              <h4>Payment Account Setup</h4>
            </div>
            
            <p style="color: var(--text-gray); margin-bottom: 20px; line-height: 1.6;">
              Set up your payment account to receive payments directly to your bank.
            </p>
            
            <div class="provider-options">
              <div class="provider-option" data-provider="flutterwave">
                <i class="fas fa-globe"></i>
                <h5>Flutterwave</h5>
                <p>Global coverage, supports multiple currencies</p>
              </div>
              
              <div class="provider-option" data-provider="paystack">
                <i class="fas fa-map-marker-alt"></i>
                <h5>Paystack</h5>
                <p>African markets focus, local payment methods</p>
              </div>
            </div>
            
            <input type="hidden" id="p_paymentProvider" value="" />
            <div id="p_paymentProvider_error" class="form-error"></div>
            
            <div id="businessInfo" class="conditional-section" style="margin-top: 24px;">
              <div class="form-section-header" style="margin-bottom: 16px;">
                <i class="fas fa-building"></i>
                <h4>Business Information</h4>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Business Name <span class="required">*</span></label>
                  <input type="text" id="p_businessName" class="form-input" placeholder="e.g. John's Digital Store" required />
                  <div id="p_businessName_error" class="form-error"></div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Country <span class="required">*</span></label>
                  <input type="text" id="p_country" class="form-input" placeholder="e.g. United States, Germany, Kenya" required />
                  <div id="p_country_error" class="form-error"></div>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Business Email <span class="required">*</span></label>
                  <input type="email" id="p_businessEmail" class="form-input" placeholder="e.g. business@example.com" required />
                  <div id="p_businessEmail_error" class="form-error"></div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Phone Number <span class="required">*</span></label>
                  <input type="tel" id="p_businessPhone" class="form-input" placeholder="e.g. +1234567890" required />
                  <div id="p_businessPhone_error" class="form-error"></div>
                </div>
              </div>
              
              <div id="bankDetails" class="conditional-section show">
                <div class="form-section-header" style="margin-bottom: 16px;">
                  <i class="fas fa-university"></i>
                  <h4>Bank Account Details</h4>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Bank Name <span class="required">*</span></label>
                    <input type="text" id="p_bankName" class="form-input" placeholder="e.g. Chase Bank, Barclays, Standard Bank" required />
                    <div id="p_bankName_error" class="form-error"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Bank Code <span class="required">*</span></label>
                    <input type="text" id="p_bankCode" class="form-input" placeholder="e.g. 021000021, 20-00-00, 051001" required />
                    <div id="p_bankCode_error" class="form-error"></div>
                    <span class="form-help">Routing number, sort code, or bank code</span>
                  </div>
                </div>
                
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Account Number <span class="required">*</span></label>
                    <input type="text" id="p_accountNumber" class="form-input" placeholder="e.g. 0123456789" required />
                    <div id="p_accountNumber_error" class="form-error"></div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Account Holder <span class="required">*</span></label>
                    <input type="text" id="p_accountName" class="form-input" placeholder="e.g. John Doe" required />
                    <div id="p_accountName_error" class="form-error"></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="commission-card">
              <h5><i class="fas fa-percentage"></i> Commission Structure</h5>
              <div class="commission-structure">
                <div class="commission-item">
                  <i class="fas fa-chart-line"></i>
                  <span><strong>10%</strong> Platform Fee</span>
                </div>
                <div class="commission-item">
                  <i class="fas fa-wallet"></i>
                  <span><strong>90%</strong> You Keep</span>
                </div>
                <div class="commission-item">
                  <i class="fas fa-bolt"></i>
                  <span><strong>Instant</strong> Payouts</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Images -->
          <div class="form-section">
            <div class="form-section-header">
              <i class="fas fa-images"></i>
              <h4>Product Images</h4>
            </div>
            
            <div class="form-group">
              <label class="form-label">Upload Images <span class="required">*</span></label>
              <div class="file-upload">
                <input type="file" id="p_images" accept="image/*" multiple required />
                <label for="p_images" class="file-upload-label">
                  <i class="fas fa-camera"></i>
                  <span>Click to upload product images</span>
                  <small>Select multiple images (JPG, PNG, WebP) • At least one required</small>
                </label>
              </div>
              <div id="p_images_error" class="form-error"></div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button id="uploadProductBtn" class="form-btn primary">
              <i class="fas fa-rocket"></i>
              Create Account & Publish Product
            </button>
            <button id="saveDraftBtn" class="form-btn secondary">
              <i class="fas fa-save"></i>
              Save as Draft
            </button>
          </div>
          
          <div id="uploadMessage" class="form-success"></div>
        </div>

        <!-- Sidebar Tips -->
        <div class="form-sidebar">
          <div class="info-card">
            <h4><i class="fas fa-lightbulb"></i> Tips for Success</h4>
            <ul class="info-list">
              <li><i class="fas fa-check-circle"></i> <strong>High-quality images</strong> increase sales</li>
              <li><i class="fas fa-check-circle"></i> <strong>Detailed descriptions</strong> build trust</li>
              <li><i class="fas fa-check-circle"></i> <strong>Clear pricing</strong> reduces confusion</li>
              <li><i class="fas fa-check-circle"></i> <strong>Multiple images</strong> from different angles</li>
            </ul>
          </div>
          
          <div class="info-card">
            <h4><i class="fas fa-shield-alt"></i> Secure & Reliable</h4>
            <ul class="info-list">
              <li><i class="fas fa-lock"></i> <strong>Bank-level security</strong></li>
              <li><i class="fas fa-bolt"></i> <strong>Instant payouts</strong></li>
              <li><i class="fas fa-headset"></i> <strong>24/7 support</strong></li>
              <li><i class="fas fa-chart-line"></i> <strong>Sales analytics</strong></li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= PRODUCTS GRID ================= -->
    <section id="buyerView">
      <div id="productsGrid" class="grid"></div>
      <div id="noProducts" style="display:none;">
        <i class="fas fa-search"></i>
        <h3>No products found</h3>
        <p>Try adjusting your search or filter criteria</p>
      </div>
    </section>

    <!-- ================= REVIEWS SECTION ================= -->
    <div id="productReviewsSection" class="reviews-section">
      <h3>Customer Reviews</h3>

      <!-- Average rating -->
      <div id="averageRating" class="average-rating"></div>

      <!-- Reviews list -->
      <div id="reviewsList" class="reviews-list">
        <p style="color: var(--text-gray)">Select a product to view reviews</p>
      </div>

      <!-- Submit review (logged-in users only) -->
      <div id="reviewFormWrapper" class="review-form hidden">
        <h4>Leave a Review</h4>

        <select id="reviewRating" class="form-select">
          <option value="">Select rating</option>
          <option value="5">⭐⭐⭐⭐⭐ (5)</option>
          <option value="4">⭐⭐⭐⭐ (4)</option>
          <option value="3">⭐⭐⭐ (3)</option>
          <option value="2">⭐⭐ (2)</option>
          <option value="1">⭐ (1)</option>
        </select>

        <textarea
          id="reviewComment"
          placeholder="Share your experience with this product..."
        ></textarea>

        <button onclick="submitReview()">Submit Review</button>
        <p id="reviewMessage" class="form-message"></p>
      </div>
    </div>
  </main>

  <!-- ================= MODALS ================= -->
  <div id="loginModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Login to Core Insight</h3>
        <span id="closeLogin" class="close-x">&times;</span>
      </div>

      <div style="margin-top:20px">
        <div style="display:flex;background:rgba(255,255,255,0.03);border-radius:var(--radius-md);overflow:hidden">
          <button id="loginByUsername" class="toggleLoginBtn" style="flex:1;padding:12px;border:none;background:var(--accent);color:white;font-weight:500">Username</button>
          <button id="loginByEmail" class="toggleLoginBtn" style="flex:1;padding:12px;border:none;background:transparent;color:var(--text-gray);font-weight:500">Email</button>
        </div>

        <form id="loginForm" style="margin-top:20px">
          <div id="usernameGroup" style="margin-bottom:16px">
            <input id="loginUsername" placeholder="Username" class="form-input" />
          </div>
          <div id="emailGroup" style="display:none;margin-bottom:16px">
            <input id="loginEmail" type="email" placeholder="Email address" class="form-input" />
          </div>

          <div style="margin-bottom:20px;position:relative">
            <input id="loginPassword" type="password" placeholder="Password" class="form-input" style="padding-right:48px" />
            <button type="button" id="toggleLoginPwd" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-gray);cursor:pointer">👁</button>
          </div>

          <div style="display:flex;gap:12px">
            <button type="submit" class="btn primary" style="flex:1">Login</button>
            <button id="openSignupFromLogin" type="button" class="btn" style="flex:1">Sign up</button>
          </div>
        </form>
        <div id="loginMsg" style="margin-top:16px"></div>
      </div>
    </div>
  </div>

  <div id="signupModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Create account</h3>
        <span id="closeSignup" class="close-x">&times;</span>
      </div>

      <form id="signupForm" style="margin-top:20px">
        <div style="margin-bottom:16px">
          <input id="signupUsername" placeholder="Username" required class="form-input" />
        </div>
        <div style="margin-bottom:16px">
          <input id="signupEmail" type="email" placeholder="Email" required class="form-input" />
        </div>
        <div style="margin-bottom:20px;position:relative">
          <input id="signupPassword" type="password" placeholder="Password" required class="form-input" style="padding-right:48px" />
          <button type="button" id="toggleSignupPwd" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-gray);cursor:pointer">👁</button>
        </div>

        <div style="display:flex;gap:12px">
          <button type="submit" class="btn primary" style="flex:1">Sign up</button>
          <button id="openLoginFromSignup" type="button" class="btn" style="flex:1">Login</button>
        </div>
      </form>

      <div id="signupMsg" style="margin-top:16px"></div>
    </div>
  </div>
<!-- ================= DASHBOARD SECTION ================= -->
<section id="dashboardSection" class="dashboard-section" style="display: none;">
  <div class="dashboard-header">
    <div class="dashboard-title">
      <h2><i class="fas fa-chart-line"></i> Seller Dashboard</h2>
      <span id="dashboardRoleBadge" class="role-badge">Seller</span>
    </div>
    
    <div class="dashboard-actions">
      <button id="toggleDashboard" class="btn primary">
        <i class="fas fa-store"></i>
        Back to Products
      </button>
      <button id="exportData" class="btn secondary" title="Export dashboard data">
        <i class="fas fa-file-export"></i>
        Export
      </button>
    </div>
  </div>

  <!-- Admin Controls (Visible only to admins) -->
  <div id="adminControls" class="admin-controls" style="display: none;">
    <div class="admin-search-bar">
      <input type="text" id="adminGlobalSearch" placeholder="Search users, products, orders..." 
             class="search-input" style="flex: 1;">
      <select id="adminSearchCategory" class="select">
        <option value="all">All Categories</option>
        <option value="users">Users</option>
        <option value="products">Products</option>
        <option value="orders">Orders</option>
        <option value="sales">Sales</option>
      </select>
      <button id="adminSearchBtn" class="btn primary">
        <i class="fas fa-search"></i>
        Search
      </button>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2);">
        <i class="fas fa-box-open" style="color: var(--accent);"></i>
      </div>
      <div class="stat-content">
        <h3 id="totalProducts">0</h3>
        <p>Total Products</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2);">
        <i class="fas fa-shopping-cart" style="color: var(--success);"></i>
      </div>
      <div class="stat-content">
        <h3 id="totalSales">0</h3>
        <p>Total Sales</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon" style="background: rgba(245, 158, 11, 0.2);">
        <i class="fas fa-money-bill-wave" style="color: var(--warning);"></i>
      </div>
      <div class="stat-content">
        <h3 id="totalRevenue">$0</h3>
        <p>Total Revenue</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon" style="background: rgba(139, 92, 246, 0.2);">
        <i class="fas fa-star" style="color: var(--digital);"></i>
      </div>
      <div class="stat-content">
        <h3 id="avgRating">0.0</h3>
        <p>Average Rating</p>
      </div>
    </div>
  </div>

  <!-- Dashboard Tabs -->
  <div class="dashboard-tabs">
    <div class="tabs-header">
      <button class="tab-btn active" data-tab="products">My Products</button>
      <button class="tab-btn" data-tab="sales">Sales History</button>
      <button class="tab-btn" data-tab="analytics">Analytics</button>
      <button id="adminTab" class="tab-btn" data-tab="admin" style="display: none;">Admin Panel</button>
    </div>
    
    <div class="tabs-content">
      <!-- My Products Tab -->
      <div id="productsTab" class="tab-content active">
        <div class="tab-header">
          <h3><i class="fas fa-box"></i> My Listed Products</h3>
          <div class="tab-actions">
            <input type="text" id="searchMyProducts" placeholder="Search my products..." 
                   class="search-input" style="width: 250px;">
            <select id="filterMyProducts" class="select">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="sold">Sold</option>
              <option value="draft">Draft</option>
            </select>
          </div>
        </div>
        
        <div id="myProductsList" class="products-table">
          <!-- Will be populated by JavaScript -->
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h4>No products yet</h4>
            <p>Start by listing your first product</p>
          </div>
        </div>
      </div>
      
      <!-- Sales History Tab -->
      <div id="salesTab" class="tab-content">
        <div class="tab-header">
          <h3><i class="fas fa-chart-bar"></i> Sales History</h3>
          <div class="tab-actions">
            <select id="salesPeriod" class="select">
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
              <option value="all">All Time</option>
            </select>
            <select id="salesStatus" class="select">
              <option value="all">All Status</option>
              <option value="completed">Completed</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
            </select>
          </div>
        </div>
        
        <div id="salesList" class="sales-table">
          <!-- Will be populated by JavaScript -->
          <div class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <h4>No sales yet</h4>
            <p>Your sales will appear here</p>
          </div>
        </div>
        
        <div class="sales-summary">
          <div class="summary-card">
            <h4>Total Sales Value</h4>
            <h2 id="totalSalesValue">$0.00</h2>
          </div>
          <div class="summary-card">
            <h4>Your Earnings</h4>
            <h2 id="yourEarnings">$0.00</h2>
          </div>
          <div class="summary-card">
            <h4>Platform Fee</h4>
            <h2 id="platformFee">$0.00</h2>
          </div>
        </div>
      </div>
      
      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3><i class="fas fa-chart-line"></i> Sales Overview</h3>
            <div class="chart-container">
              <canvas id="salesChart"></canvas>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3><i class="fas fa-chart-pie"></i> Product Categories</h3>
            <div class="chart-container">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3><i class="fas fa-chart-bar"></i> Monthly Performance</h3>
            <div class="stats-list">
              <div class="stat-item">
                <span>Best Selling Product</span>
                <strong id="bestProduct">N/A</strong>
              </div>
              <div class="stat-item">
                <span>Total Visitors</span>
                <strong id="totalVisitors">0</strong>
              </div>
              <div class="stat-item">
                <span>Conversion Rate</span>
                <strong id="conversionRate">0%</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Admin Panel Tab -->
      <div id="adminTabContent" class="tab-content">
        <div class="admin-panel">
          <div class="admin-section">
            <h3><i class="fas fa-users"></i> User Management</h3>
            <div class="admin-table">
              <table id="usersTable">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Products</th>
                    <th>Sales</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="admin-section">
            <h3><i class="fas fa-shopping-bag"></i> All Products Monitor</h3>
            <div class="admin-filters">
              <input type="text" id="adminProductSearch" placeholder="Search products..." class="search-input">
              <select id="adminProductCategory" class="select">
                <option value="">All Categories</option>
              </select>
              <select id="adminProductStatus" class="select">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="suspended">Suspended</option>
              </select>
            </div>
            <div class="admin-table">
              <table id="allProductsTable">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Seller</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Sales</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="admin-section">
            <h3><i class="fas fa-chart-pie"></i> Platform Analytics</h3>
            <div class="platform-stats">
              <div class="platform-stat">
                <h4>Total Users</h4>
                <h2 id="platformTotalUsers">0</h2>
              </div>
              <div class="platform-stat">
                <h4>Total Products</h4>
                <h2 id="platformTotalProducts">0</h2>
              </div>
              <div class="platform-stat">
                <h4>Total Sales</h4>
                <h2 id="platformTotalSales">0</h2>
              </div>
              <div class="platform-stat">
                <h4>Platform Revenue</h4>
                <h2 id="platformRevenue">$0.00</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* ================= DASHBOARD STYLES ================= */
  .dashboard-section {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    padding: 32px;
    margin-top: 32px;
    border: 1px solid var(--border);
    animation: fadeIn 0.3s ease;
  }

  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .dashboard-title {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .dashboard-title h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .role-badge {
    background: var(--accent);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .dashboard-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Admin Controls */
  .admin-controls {
    background: rgba(59, 130, 246, 0.05);
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 24px;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .admin-search-bar {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: rgba(15, 23, 42, 0.5);
    border-radius: var(--radius-lg);
    padding: 24px;
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: var(--transition);
  }

  .stat-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .stat-icon {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-content h3 {
    margin: 0 0 4px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--text-light);
  }

  .stat-content p {
    margin: 0;
    color: var(--text-gray);
    font-size: 14px;
  }

  /* Dashboard Tabs */
  .dashboard-tabs {
    background: rgba(15, 23, 42, 0.5);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .tabs-header {
    display: flex;
    background: var(--primary-dark);
    border-bottom: 1px solid var(--border);
  }

  .tab-btn {
    padding: 16px 24px;
    background: transparent;
    border: none;
    color: var(--text-gray);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .tab-btn:hover {
    color: var(--text-light);
    background: rgba(255, 255, 255, 0.02);
  }

  .tab-btn.active {
    color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
  }

  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--accent);
  }

  .tabs-content {
    padding: 32px;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  /* Tab Headers */
  .tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .tab-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .tab-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Products Table */
  .products-table {
    background: var(--primary-dark);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .products-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .products-table th {
    background: var(--card-bg);
    padding: 16px;
    text-align: left;
    color: var(--text-light);
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid var(--border);
  }

  .products-table td {
    padding: 16px;
    color: var(--text-gray);
    font-size: 14px;
    border-bottom: 1px solid var(--border);
  }

  .products-table tr:hover {
    background: var(--card-bg-hover);
  }

  .product-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }

  .status-active {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
  }

  .status-sold {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
  }

  .status-draft {
    background: rgba(100, 116, 139, 0.2);
    color: var(--text-muted);
  }

  /* Sales Table */
  .sales-table {
    background: var(--primary-dark);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 24px;
  }

  .sales-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 32px;
  }

  .summary-card {
    background: rgba(15, 23, 42, 0.5);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border);
    text-align: center;
  }

  .summary-card h4 {
    margin: 0 0 8px 0;
    color: var(--text-gray);
    font-size: 14px;
    font-weight: 500;
  }

  .summary-card h2 {
    margin: 0;
    color: var(--text-light);
    font-size: 28px;
    font-weight: 700;
  }

  /* Analytics Grid */
  .analytics-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
  }

  .analytics-card {
    background: rgba(15, 23, 42, 0.5);
    border-radius: var(--radius-lg);
    padding: 24px;
    border: 1px solid var(--border);
  }

  .analytics-card h3 {
    margin: 0 0 20px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chart-container {
    height: 200px;
    position: relative;
  }

  .stats-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--primary-dark);
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
  }

  .stat-item span {
    color: var(--text-gray);
    font-size: 14px;
  }

  .stat-item strong {
    color: var(--text-light);
    font-size: 16px;
    font-weight: 600;
  }

  /* Admin Panel */
  .admin-panel {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .admin-section {
    background: rgba(15, 23, 42, 0.5);
    border-radius: var(--radius-lg);
    padding: 24px;
    border: 1px solid var(--border);
  }

  .admin-section h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .admin-filters {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  .admin-table {
    overflow-x: auto;
  }

  .admin-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .admin-table th {
    background: var(--card-bg);
    padding: 12px 16px;
    text-align: left;
    color: var(--text-light);
    font-weight: 600;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  .admin-table td {
    padding: 12px 16px;
    color: var(--text-gray);
    font-size: 13px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .admin-table tr:hover {
    background: var(--card-bg-hover);
  }

  .user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 12px;
  }

  .platform-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  .platform-stat {
    background: var(--primary-dark);
    border-radius: var(--radius-lg);
    padding: 20px;
    border: 1px solid var(--border);
    text-align: center;
  }

  .platform-stat h4 {
    margin: 0 0 8px 0;
    color: var(--text-gray);
    font-size: 14px;
    font-weight: 500;
  }

  .platform-stat h2 {
    margin: 0;
    color: var(--text-light);
    font-size: 24px;
    font-weight: 700;
  }

  /* Action Buttons */
  .action-btn {
    padding: 6px 12px;
    border-radius: var(--radius-md);
    border: none;
    background: transparent;
    color: var(--text-gray);
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .action-btn:hover {
    background: var(--card-bg-hover);
  }

  .action-btn.view {
    color: var(--accent);
  }

  .action-btn.edit {
    color: var(--warning);
  }

  .action-btn.delete {
    color: var(--danger);
  }

  .action-btn.suspend {
    color: var(--warning);
  }

  /* Empty States */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-gray);
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  .empty-state h4 {
    margin: 0 0 8px 0;
    color: var(--text-light);
    font-weight: 600;
  }

  .empty-state p {
    margin: 0;
    font-size: 14px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .analytics-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .dashboard-actions {
      width: 100%;
      justify-content: flex-end;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
    
    .tab-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    
    .tab-actions {
      width: 100%;
      flex-direction: column;
    }
    
    .tab-actions .search-input,
    .tab-actions .select {
      width: 100%;
    }
  }
  /* Add to existing dashboard styles */
.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.products-table table, .sales-table table, .admin-table table {
  width: 100%;
  border-collapse: collapse;
}

.products-table th, .sales-table th, .admin-table th {
  background: var(--card-bg);
  padding: 12px 16px;
  text-align: left;
  color: var(--text-light);
  font-weight: 600;
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.products-table td, .sales-table td, .admin-table td {
  padding: 12px 16px;
  color: var(--text-gray);
  font-size: 13px;
  border-bottom: 1px solid var(--border);
}

.products-table tr:hover, .sales-table tr:hover, .admin-table tr:hover {
  background: var(--card-bg-hover);
}

.user-avatar-small {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 12px;
}
</style>

<script>
// Dashboard JavaScript Code
document.addEventListener('DOMContentLoaded', function() {
  // Dashboard toggle button
  const dashboardBtn = document.createElement('button');
  dashboardBtn.className = 'become-seller';
  dashboardBtn.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
  dashboardBtn.style.marginLeft = '8px';
  dashboardBtn.id = 'toggleDashboardBtn';
  
  // Add dashboard button to header
  const viewToggle = document.querySelector('.view-toggle');
  if (viewToggle) {
    viewToggle.appendChild(dashboardBtn);
  }
  
  // Dashboard elements
  const dashboardSection = document.getElementById('dashboardSection');
  const buyerView = document.getElementById('buyerView');
  const sellerView = document.getElementById('sellerView');
  const toggleDashboardBtn = document.getElementById('toggleDashboardBtn');
  const toggleDashboard = document.getElementById('toggleDashboard');
  const becomeSellerBtn = document.getElementById('becomeSeller');
  
  // Tab elements
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  // Initialize dashboard
  let isDashboardVisible = false;
  let currentUser = null;
  let dashboardData = null;
  
  // Check user login status
  checkLoginStatus();
  
  // Dashboard toggle functionality
  toggleDashboardBtn.addEventListener('click', function() {
    toggleDashboardView();
  });
  
  if (toggleDashboard) {
    toggleDashboard.addEventListener('click', function() {
      toggleDashboardView();
    });
  }
  
  // Tab switching
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      
      // Update active tab button
      tabBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Show selected tab content
      tabContents.forEach(content => {
        content.classList.remove('active');
        if (content.id === tabId + 'Tab' || content.id === tabId + 'TabContent') {
          content.classList.add('active');
        }
      });
      
      // Load data for the selected tab
      loadTabData(tabId);
    });
  });
  
  // Functions
  function toggleDashboardView() {
    isDashboardVisible = !isDashboardVisible;
    
    if (isDashboardVisible) {
      // Show dashboard, hide other views
      dashboardSection.style.display = 'block';
      buyerView.style.display = 'none';
      sellerView.style.display = 'none';
      
      // Update button text
      toggleDashboardBtn.innerHTML = '<i class="fas fa-store"></i> Products';
      if (toggleDashboard) {
        toggleDashboard.innerHTML = '<i class="fas fa-store"></i> Back to Products';
      }
      
      // Load dashboard data
      loadDashboardData();
    } else {
      // Hide dashboard, show products view
      dashboardSection.style.display = 'none';
      buyerView.style.display = 'block';
      
      // Update button text
      toggleDashboardBtn.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
      if (toggleDashboard) {
        toggleDashboard.innerHTML = '<i class="fas fa-chart-line"></i> Dashboard';
      }
    }
  }
  
  async function checkLoginStatus() {
    try {
      const response = await fetch('/api/me');
      if (response.ok) {
        const user = await response.json();
        currentUser = user;
        updateDashboardForUser(user);
      } else {
        currentUser = null;
      }
    } catch (error) {
      console.error('Error checking login status:', error);
      currentUser = null;
    }
  }
  
  function updateDashboardForUser(user) {
    const dashboardRoleBadge = document.getElementById('dashboardRoleBadge');
    const adminTab = document.getElementById('adminTab');
    const adminControls = document.getElementById('adminControls');
    
    if (user && user.role === 'admin') {
      // Show admin features
      dashboardRoleBadge.textContent = 'Admin';
      dashboardRoleBadge.style.background = 'var(--danger)';
      
      if (adminTab) adminTab.style.display = 'block';
      if (adminControls) adminControls.style.display = 'block';
    } else if (user) {
      // Regular seller
      dashboardRoleBadge.textContent = 'Seller';
      dashboardRoleBadge.style.background = 'var(--accent)';
      
      if (adminTab) adminTab.style.display = 'none';
      if (adminControls) adminControls.style.display = 'none';
    }
    
    // Update welcome message if needed
    const welcomeElement = document.querySelector('.dashboard-title h2');
    if (welcomeElement && user) {
      welcomeElement.innerHTML = `<i class="fas fa-chart-line"></i> ${user.role === 'admin' ? 'Admin' : 'Seller'} Dashboard`;
    }
  }
  
  async function loadDashboardData() {
    if (!currentUser) {
      showToast('Please login to view dashboard', 'warning');
      toggleDashboardView();
      return;
    }
    
    try {
      // Show loading state
      showLoadingState();
      
      // Load dashboard statistics
      await loadDashboardStats();
      
      // Load initial tab data
      loadTabData('products');
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
      showToast('Failed to load dashboard data', 'danger');
    }
  }
 // Update the loadDashboardStats function:

// Update the loadDashboardStats function:
async function loadDashboardStats() {
  try {
    let stats;
    
    if (currentUser.role === 'admin') {
      // Admin gets platform-wide stats
      const [platformRes, summaryRes] = await Promise.all([
        fetch('/api/admin/platform/stats'),
        fetch('/api/admin/dashboard/summary')
      ]);
      
      const platformData = platformRes.ok ? await platformRes.json() : {};
      const summaryData = summaryRes.ok ? await summaryRes.json() : {};
      
      stats = {
        totalProducts: platformData.stats?.total_products || 0,
        totalSales: platformData.stats?.total_sales || 0,
        totalRevenue: `$${(platformData.stats?.total_revenue || 0).toFixed(2)}`,
        avgRating: '4.5'
      };
      
      // Update platform stats for admin
      document.getElementById('platformTotalUsers').textContent = platformData.stats?.total_users || 0;
      document.getElementById('platformTotalProducts').textContent = stats.totalProducts;
      document.getElementById('platformTotalSales').textContent = stats.totalSales;
      document.getElementById('platformRevenue').textContent = `$${(platformData.stats?.platform_revenue || 0).toFixed(2)}`;
      
    } else {
      // Regular user gets their own stats
      const statsRes = await fetch(`/api/seller/stats/${currentUser.id}`);
      const statsData = statsRes.ok ? await statsRes.json() : {};
      
      stats = {
        totalProducts: statsData.stats?.product_count || 0,
        totalSales: statsData.stats?.sales_count || 0,
        totalRevenue: `$${(statsData.stats?.total_revenue || 0).toFixed(2)}`,
        avgRating: statsData.stats?.avg_rating?.toFixed(1) || '0.0'
      };
      
      // Update summary cards
      const totalRevenue = statsData.stats?.total_revenue || 0;
      const userEarnings = totalRevenue * 0.9; // 90% for seller
      const platformFee = totalRevenue * 0.1; // 10% platform fee
      
      document.getElementById('totalSalesValue').textContent = `$${totalRevenue.toFixed(2)}`;
      document.getElementById('yourEarnings').textContent = `$${userEarnings.toFixed(2)}`;
      document.getElementById('platformFee').textContent = `$${platformFee.toFixed(2)}`;
    }
    
    // Update stats cards
    document.getElementById('totalProducts').textContent = stats.totalProducts;
    document.getElementById('totalSales').textContent = stats.totalSales;
    document.getElementById('totalRevenue').textContent = stats.totalRevenue;
    document.getElementById('avgRating').textContent = stats.avgRating;
    
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Update the loadSalesHistory function:

async function loadSalesHistory() {
  const container = document.getElementById('salesList');
  const period = document.getElementById('salesPeriod').value;
  
  try {
    let sales = [];
    
    if (currentUser.role === 'admin') {
      // Admin gets all sales
      const response = await fetch('/api/admin/analytics/sales');
      const data = await response.json();
      sales = data.sales_trend || [];
    } else {
      // User gets their sales
      const response = await fetch(`/api/orders/seller/${currentUser.id}`);
      sales = await response.json();
    }
    
    if (!sales || sales.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-shopping-cart"></i>
          <h4>No sales yet</h4>
          <p>Your sales will appear here</p>
        </div>
      `;
      return;
    }
    
    // Create table
    let html = `
      <table>
        <thead>
          <tr>
            <th>Order</th>
            <th>Product</th>
            <th>Amount</th>
            <th>Date</th>
            ${currentUser.role === 'admin' ? '<th>Buyer</th><th>Seller</th>' : '<th>Buyer</th>'}
          </tr>
        </thead>
        <tbody>
    `;
    
    sales.forEach(sale => {
      html += `
        <tr>
          <td>
            <strong style="color: var(--accent);">${sale.order_code || 'N/A'}</strong>
          </td>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 32px; height: 32px; border-radius: 6px; background: var(--secondary-dark);"></div>
              <span style="color: var(--text-light); font-size: 13px;">${sale.product_name || sale.product_title || 'Product'}</span>
            </div>
          </td>
          <td>
            <strong style="color: var(--success);">$${parseFloat(sale.price || sale.total_amount || 0).toFixed(2)}</strong>
          </td>
          <td>
            <span style="color: var(--text-gray); font-size: 12px;">${formatDate(sale.created_at)}</span>
          </td>
          ${currentUser.role === 'admin' ? `
            <td>
              <span style="color: var(--text-light);">${sale.buyer_name || 'Buyer'}</span>
            </td>
            <td>
              <span style="color: var(--text-light);">${sale.seller_name || 'Seller'}</span>
            </td>
          ` : `
            <td>
              <span style="color: var(--text-light);">${sale.buyer_name || 'Customer'}</span>
            </td>
          `}
        </tr>
      `;
    });
    
    html += `</tbody></table>`;
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading sales:', error);
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h4>Error loading sales</h4>
        <p>Please try again later</p>
      </div>
    `;
  }
}

// Update the loadUsersTable function:

async function loadUsersTable() {
  const tbody = document.querySelector('#usersTable tbody');
  
  try {
    const response = await fetch('/api/admin/users');
    const users = await response.json();
    
    if (!users || users.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-gray);">
            No users found
          </td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    users.forEach(user => {
      html += `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div class="user-avatar-small">${user.username[0]}</div>
              <div>
                <div style="color: var(--text-light); font-weight: 500;">${user.username}</div>
                <small style="color: var(--text-gray);">${user.email}</small>
              </div>
            </div>
          </td>
          <td>
            <span class="product-status ${user.role}">${user.role}</span>
          </td>
          <td>
            <span style="color: var(--text-light);">${user.product_count || 0}</span>
          </td>
          <td>
            <span style="color: var(--success);">${user.sales_count || 0}</span>
          </td>
          <td>
            <span class="product-status ${user.verified ? 'active' : 'pending'}">
              ${user.verified ? 'Verified' : 'Pending'}
            </span>
          </td>
          <td>
            <div style="display: flex; gap: 8px;">
              <button class="action-btn view" onclick="viewUser(${user.id})">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn suspend" onclick="toggleUserStatus(${user.id}, ${user.active ? 'false' : 'true'})">
                <i class="fas fa-ban"></i>
              </button>
              <button class="action-btn delete" onclick="deleteUser(${user.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading users:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-gray);">
          Error loading users
        </td>
      </tr>
    `;
  }
}
  async function loadAllProductsTable() {
    const tbody = document.querySelector('#allProductsTable tbody');
    
    try {
      const response = await fetch('/api/products');
      const products = await response.json();
      
      let html = '';
      products.forEach(product => {
        // Get seller info (you might need to fetch this separately)
        const sellerName = product.user_id === currentUser.id ? 'You' : `Seller ${product.user_id}`;
        
        html += `
          <tr>
            <td>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--secondary-dark); overflow: hidden;">
                  ${product.images ? 
                    `<img src="${JSON.parse(product.images)[0]}" alt="${product.title}" style="width: 100%; height: 100%; object-fit: cover;">` :
                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-gray);">
                      <i class="fas fa-box"></i>
                    </div>`
                  }
                </div>
                <div>
                  <strong style="color: var(--text-light); display: block; font-size: 13px;">${product.title}</strong>
                  <small style="color: var(--text-gray); font-size: 11px;">${product.category || 'Uncategorized'}</small>
                </div>
              </div>
            </td>
            <td>
              <span style="color: var(--text-light);">${sellerName}</span>
            </td>
            <td>
              <span class="product-badge badge-${product.type}">${product.type}</span>
            </td>
            <td>
              <strong style="color: var(--accent);">$${parseFloat(product.price).toFixed(2)}</strong>
            </td>
            <td>
              <span style="color: var(--success);">${product.sales_count || 0}</span>
            </td>
            <td>
              <span class="product-status active">Active</span>
            </td>
            <td>
              <div style="display: flex; gap: 8px;">
                <button class="action-btn view" onclick="viewProduct(${product.id})">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn suspend" onclick="suspendProduct(${product.id})">
                  <i class="fas fa-pause"></i>
                </button>
                <button class="action-btn delete" onclick="deleteProductAsAdmin(${product.id})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
      
    } catch (error) {
      console.error('Error loading products:', error);
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-gray);">
            Error loading products
          </td>
        </tr>
      `;
    }
  }
  
  function loadCharts() {
    // Sales Chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
          label: 'Sales',
          data: [12, 19, 3, 5, 2, 3],
          borderColor: 'var(--accent)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: 'var(--text-light)'
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: 'var(--border)'
            },
            ticks: {
              color: 'var(--text-gray)'
            }
          },
          y: {
            grid: {
              color: 'var(--border)'
            },
            ticks: {
              color: 'var(--text-gray)'
            }
          }
        }
      }
    });
    
    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: ['Digital', 'Physical', 'Affiliate'],
        datasets: [{
          data: [40, 35, 25],
          backgroundColor: [
            'var(--digital)',
            'var(--physical)',
            'var(--affiliate)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: 'var(--text-light)',
              padding: 20
            }
          }
        }
      }
    });
  }
  
  // Helper functions
  function getProductStatus(product) {
    if (product.sales_count > 0) return 'sold';
    if (product.status === 'draft') return 'draft';
    return 'active';
  }
  
  function generateStarRating(rating) {
    const stars = Math.round(rating);
    let html = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= stars) {
        html += '<i class="fas fa-star"></i>';
      } else {
        html += '<i class="far fa-star"></i>';
      }
    }
    return html;
  }
  
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  }
  
  function filterSalesByPeriod(sales, period) {
    const now = new Date();
    const filtered = sales.filter(sale => {
      const saleDate = new Date(sale.created_at);
      
      switch(period) {
        case 'today':
          return saleDate.toDateString() === now.toDateString();
        case 'week':
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return saleDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          return saleDate >= monthAgo;
        case 'year':
          const yearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
          return saleDate >= yearAgo;
        default:
          return true;
      }
    });
    
    return filtered;
  }
  
  function showLoadingState() {
    // Add loading state to dashboard
    const containers = ['myProductsList', 'salesList', 'usersTable tbody', 'allProductsTable tbody'];
    containers.forEach(selector => {
      const element = document.getElementById(selector) || document.querySelector(selector);
      if (element) {
        element.innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--text-gray);">
            <div class="skeleton" style="width: 100%; height: 20px; margin-bottom: 12px;"></div>
            <div class="skeleton" style="width: 80%; height: 20px; margin: 0 auto;"></div>
          </div>
        `;
      }
    });
  }
  
  function showToast(message, type = 'info') {
    // Use your existing toast system
    const toast = document.createElement('div');
    toast.className = `toast ${type} show`;
    toast.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
      <div class="toast-content">
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close">&times;</button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      toast.remove();
    }, 5000);
    
    // Close button
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.remove();
    });
  }
  
  // Event listeners for dashboard filters
  document.getElementById('salesPeriod')?.addEventListener('change', () => loadSalesHistory());
  document.getElementById('salesStatus')?.addEventListener('change', () => loadSalesHistory());
  document.getElementById('searchMyProducts')?.addEventListener('input', debounce(loadMyProducts, 300));
  document.getElementById('filterMyProducts')?.addEventListener('change', loadMyProducts);
  
  // Admin search functionality
  document.getElementById('adminSearchBtn')?.addEventListener('click', performAdminSearch);
  document.getElementById('adminGlobalSearch')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') performAdminSearch();
  });
  
  async function performAdminSearch() {
    const searchTerm = document.getElementById('adminGlobalSearch').value;
    const category = document.getElementById('adminSearchCategory').value;
    
    // Implement search logic based on category
    showToast(`Searching ${category} for "${searchTerm}"`, 'info');
    
    // You would implement actual search API calls here
  }
  
  // Utility function for debouncing
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Make functions available globally for button onclick handlers
  window.viewProduct = function(productId) {
    // Implement view product functionality
    showToast(`Viewing product ${productId}`, 'info');
  };
  
  window.editProduct = function(productId) {
    // Implement edit product functionality
    showToast(`Editing product ${productId}`, 'info');
  };
  
  window.deleteProduct = function(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
      // Implement delete product API call
      showToast('Product deleted successfully', 'success');
      loadMyProducts();
    }
  };
  
  window.viewUser = function(userId) {
    // Implement view user functionality
    showToast(`Viewing user ${userId}`, 'info');
  };
  
  window.toggleUserStatus = function(userId) {
    // Implement toggle user status
    showToast(`Toggled user ${userId} status`, 'warning');
  };
  
  window.deleteUser = function(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
      // Implement delete user API call
      showToast('User deleted successfully', 'success');
      loadUsersTable();
    }
  };
  
  window.suspendProduct = function(productId) {
    if (confirm('Are you sure you want to suspend this product?')) {
      // Implement suspend product API call
      showToast('Product suspended successfully', 'warning');
      loadAllProductsTable();
    }
  };
  
  window.deleteProductAsAdmin = function(productId) {
    if (confirm('Are you sure you want to delete this product as admin?')) {
      // Implement delete product as admin API call
      showToast('Product deleted successfully', 'success');
      loadAllProductsTable();
    }
  };
  
  // Export functionality
  document.getElementById('exportData')?.addEventListener('click', function() {
    // Implement export functionality
    showToast('Exporting dashboard data...', 'info');
    // You would generate CSV/Excel file here
  });
});

function loadTabData(tabId) {
  switch(tabId) {
    case 'products':
      loadMyProducts();
      break;
    case 'sales':
      loadSalesHistory();
      break;
    case 'analytics':
      loadCharts();
      break;
    case 'admin':
      loadUsersTable();
      loadAllProductsTable();
      break;
  }
}

async function loadMyProducts() {
  const container = document.getElementById('myProductsList');
  
  try {
    if (!currentUser) return;
    
    const response = await fetch(`/api/products/seller/${currentUser.id}`);
    const products = await response.json();
    
    if (!products || products.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-box-open"></i>
          <h4>No products yet</h4>
          <p>Start by listing your first product</p>
        </div>
      `;
      return;
    }
    
    let html = `
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Type</th>
            <th>Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    products.forEach(product => {
      const status = getProductStatus(product);
      const statusClass = `status-${status}`;
      
      html += `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--secondary-dark); overflow: hidden;">
                ${product.images ? 
                  `<img src="${JSON.parse(product.images)[0]}" alt="${product.title}" style="width: 100%; height: 100%; object-fit: cover;">` :
                  `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-gray);">
                    <i class="fas fa-box"></i>
                  </div>`
                }
              </div>
              <div>
                <strong style="color: var(--text-light); display: block; font-size: 13px;">${product.title}</strong>
                <small style="color: var(--text-gray); font-size: 11px;">${product.category || 'Uncategorized'}</small>
              </div>
            </div>
          </td>
          <td>
            <span class="product-badge badge-${product.type}">${product.type}</span>
          </td>
          <td>
            <strong style="color: var(--accent);">$${parseFloat(product.price).toFixed(2)}</strong>
          </td>
          <td>
            <span class="product-status ${statusClass}">${status}</span>
          </td>
          <td>
            <div style="display: flex; gap: 8px;">
              <button class="action-btn view" onclick="viewProduct(${product.id})">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn edit" onclick="editProduct(${product.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete" onclick="deleteProduct(${product.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });
    
    html += `</tbody></table>`;
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading my products:', error);
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h4>Error loading products</h4>
        <p>Please try again later</p>
      </div>
    `;
  }
}
</script>
  <script>
    // ================= TOAST NOTIFICATION SYSTEM =================
    function showToast(title, message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                       type === 'warning' ? 'exclamation-triangle' : 
                       type === 'danger' ? 'times-circle' : 'info-circle'}"></i>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">&times;</button>
      `;
      
      document.body.appendChild(toast);
      
      // Show toast
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // Close button
      toast.querySelector('.toast-close').addEventListener('click', () => {
        hideToast(toast);
      });
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        hideToast(toast);
      }, 5000);
    }
    
    function hideToast(toast) {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }

    // ================= PRODUCT ORDER SYSTEM =================
    async function orderPhysicalProduct(productId) {
      if (!currentUser) {
        openModal($('loginModal'));
        return;
      }
      
      try {
        const product = products.find(p => p.id === productId);
        if (!product) {
          alert('Product not found');
          return;
        }
        
        // Show confirmation modal
        const confirmOrder = confirm(`Order "${product.title}"?\n\nPrice: ${fmtPrice(product.price)}\nDelivery: ${product.delivery_type || 'pickup'}\nPayment: Pay on Delivery\n\nThis will notify the seller of your interest.`);
        
        if (!confirmOrder) return;
        
        // Send order request to server
        const response = await fetch('/api/order-product', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-CSRF-Token': getCSRFToken() 
          },
          body: JSON.stringify({
            productId: productId,
            sellerId: product.user_id,
            productTitle: product.title,
            price: product.price,
            deliveryType: product.delivery_type || 'pickup'
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Show success toast
          showToast('Order Placed!', 'The seller has been notified of your interest. They will contact you soon.', 'success');
          
          // Also show success message
          alert(`✅ Order placed successfully!\n\nThe seller "${product.seller_name}" has been notified of your interest in "${product.title}".\n\nThey will contact you to arrange delivery and payment.`);
          
          console.log('Order placed:', data);
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to place order');
        }
      } catch(error) {
        console.error('Order failed:', error);
        alert('Failed to place order. Please try again.');
      }
    }
    
    window.orderPhysicalProduct = orderPhysicalProduct;

    // ================= FORM INITIALIZATION =================
    document.addEventListener('DOMContentLoaded', function() {
      // Payment provider selection
      const providerOptions = document.querySelectorAll('.provider-option');
      const paymentProviderInput = document.getElementById('p_paymentProvider');
      
      providerOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Remove selected class from all options
          providerOptions.forEach(opt => opt.classList.remove('selected'));
          
          // Add selected class to clicked option
          this.classList.add('selected');
          
          // Update hidden input value
          const provider = this.getAttribute('data-provider');
          paymentProviderInput.value = provider;
          
          // Show business info
          document.getElementById('businessInfo').classList.add('show');
        });
      });
      
      // Set physical product payment method to default to Pay on Delivery
      document.getElementById('p_paymentOption').value = 'pay_on_delivery';
    });

    // ================= FORM VALIDATION HELPERS =================
    function validateProductForm() {
      console.log("🔍 Starting form validation...");
      const errors = [];
      
      // Reset errors
      document.querySelectorAll('.form-error').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
      });
      
      // Validate required fields
      const requiredFields = [
        { id: 'p_title', errorId: 'p_title_error', message: 'Product name is required' },
        { id: 'p_price', errorId: 'p_price_error', message: 'Price is required' },
        { id: 'p_type', errorId: 'p_type_error', message: 'Product type is required' },
        { id: 'p_paymentProvider', errorId: 'p_paymentProvider_error', message: 'Payment provider is required' },
      ];
      
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        if (!element || !element.value.trim()) {
          errors.push(field);
        }
      });
      
      // Validate category
      const selectCategory = document.getElementById('p_category_select').value.trim();
      const newCategory = document.getElementById('p_category_new').value.trim();
      if (!selectCategory && !newCategory) {
        errors.push({ id: 'p_category_select', errorId: 'p_category_error', message: 'Category is required' });
      }
      
      // Validate description
      const description = document.getElementById('p_description').value.trim();
      if (!description) {
        errors.push({ id: 'p_description', errorId: 'p_description_error', message: 'Description is required' });
      }
      
      // Validate images
      const images = document.getElementById('p_images').files;
      if (!images || images.length === 0) {
        errors.push({ id: 'p_images', errorId: 'p_images_error', message: 'At least one image is required' });
      }
      
      // Display errors
      errors.forEach(error => {
        const errorEl = document.getElementById(error.errorId);
        if (errorEl) { 
          errorEl.textContent = error.message;
          errorEl.classList.add('show');
        }
      });
      
      console.log("❌ Validation errors:", errors.length);
      return errors.length === 0;
    }

    // ================= CATEGORY MANAGEMENT =================
    function getSelectedCategory() {
      const selectCategory = document.getElementById('p_category_select').value.trim();
      const newCategory = document.getElementById('p_category_new').value.trim();
      
      // Prefer new category if provided
      if (newCategory) {
        return newCategory;
      } else if (selectCategory) {
        return selectCategory;
      }
      return '';
    }

    // ================= FORM RESPONSIVENESS =================
    function toggleAffiliateFields() {
      const isAffiliate = document.getElementById('useAffiliate').checked;
      const affiliateFields = document.getElementById('affiliateFields');
      const digitalUpload = document.getElementById('digitalUpload');
      
      if (isAffiliate) {
        affiliateFields.classList.add('show');
        digitalUpload.classList.remove('show');
      } else {
        affiliateFields.classList.remove('show');
        digitalUpload.classList.add('show');
      }
    }

    // ================= PRODUCT DELETE FUNCTIONALITY =================
    // This function now properly handles owner-specific delete buttons
    function initializeProductOwnership() {
      const productCards = document.querySelectorAll('.product-card');
      
      productCards.forEach(card => {
        const productId = card.getAttribute('data-id');
        const productUserId = card.getAttribute('data-user-id');
        
        // Check if current user is the product owner or admin
        const isOwner = currentUser && (currentUser.id == productUserId || currentUser.role === 'admin');
        
        if (isOwner) {
          card.classList.add('is-owner');
          
          // Show delete button
          const deleteBtn = card.querySelector('.delete-btn');
          if (deleteBtn) deleteBtn.style.display = 'flex';
          
          // Show owner controls
          const ownerControls = card.querySelector('.owner-controls');
          if (ownerControls) ownerControls.style.display = 'flex';
        }
      });
    }

    // ---------- Utilities ----------
    const $ = (id)=>document.getElementById(id);
    let currentUser = null;
    let products = [];
    let categoriesSet = new Set();
    let currentCurrency = localStorage.getItem('ci_currency') || 'USD';
    let userFavorites = new Set();
    let sellerMode = false;
    let currentProductId = null; // For reviews

    function getCSRFToken() {
      const el = document.querySelector('meta[name="csrf-token"]');
      return el ? el.getAttribute('content') : '';
    }

    function handleApiError(err, ctx) {
      console.error(ctx, err);
      if (err && err.status === 401) {
        openModal($('loginModal'));
      }
      return (err && err.message) || `Failed to ${ctx}`;
    }

    function fmtPrice(amount){
      try {
        return new Intl.NumberFormat('en-US',{style:'currency',currency:currentCurrency}).format(Number(amount||0));
      } catch(e){
        return `${currentCurrency} ${Number(amount||0).toFixed(2)}`;
      }
    }

    function showSkeletonLoader(count = 6) {
      const grid = $('productsGrid');
      grid.innerHTML = Array(count).fill(`
        <div class="product-card skeleton">
          <div class="card-media skeleton"></div>
          <div class="card-body">
            <div class="skeleton-text"></div>
            <div class="skeleton-text short"></div>
            <div class="price-row">
              <div class="skeleton-text price"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ---------- Header & modals ----------
    const loginModal = $('loginModal');
    const signupModal = $('signupModal');

    function openModal(mod){ mod.classList.add('open'); mod.setAttribute('aria-hidden','false'); }
    function closeModal(mod){ mod.classList.remove('open'); mod.setAttribute('aria-hidden','true'); }

    // hook header buttons (initial)
    $('loginOpen').addEventListener('click', ()=> openModal(loginModal));
    $('signupOpen').addEventListener('click', ()=> openModal(signupModal));
    $('closeLogin').addEventListener('click', ()=> closeModal(loginModal));
    $('closeSignup').addEventListener('click', ()=> closeModal(signupModal));
    window.addEventListener('click', (e)=>{ if (e.target === loginModal) closeModal(loginModal); if (e.target === signupModal) closeModal(signupModal); });

    // Toggle login by username/email
    $('loginByUsername').addEventListener('click', ()=> {
      $('loginByUsername').style.color='var(--accent)'; $('loginByEmail').style.color='var(--text-gray)';
      $('usernameGroup').style.display='block'; $('emailGroup').style.display='none';
    });
    $('loginByEmail').addEventListener('click', ()=> {
      $('loginByEmail').style.color='var(--accent)'; $('loginByUsername').style.color='var(--text-gray)';
      $('usernameGroup').style.display='none'; $('emailGroup').style.display='block';
    });

    $('toggleLoginPwd').addEventListener('click', ()=> { const f=$('loginPassword'); f.type = f.type === 'password' ? 'text' : 'password'; });
    $('toggleSignupPwd').addEventListener('click', ()=> { const f=$('signupPassword'); f.type = f.type === 'password' ? 'text' : 'password'; });

    $('openSignupFromLogin').addEventListener('click', ()=>{ closeModal(loginModal); openModal(signupModal); });
    $('openLoginFromSignup').addEventListener('click', ()=>{ closeModal(signupModal); openModal(loginModal); });

    // ---------- Authentication ----------
    async function loadUser(){
      try {
        const r = await fetch('/api/me');
        if (!r.ok) { currentUser = null; updateHeader(); updateReviewFormVisibility(); return; }
        const u = await r.json();
        currentUser = u || null;
        updateHeader();
        updateReviewFormVisibility();
      } catch(err){
        console.error('loadUser', err);
        currentUser = null;
        updateHeader();
        updateReviewFormVisibility();
      }
    }

    async function loadUserFavorites() {
      try {
        const r = await fetch('/api/favorites');
        
        const contentType = r.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
          console.error('❌ Server returned HTML instead of JSON. GET /api/favorites endpoint might not exist.');
          userFavorites = new Set();
          return;
        }
        
        if (!r.ok) {
          console.log("❌ Could not load favorites - user might not be logged in or endpoint not found");
          userFavorites = new Set();
          return;
        }
        
        const data = await r.json();
        userFavorites = new Set(data.favorites || []);
        console.log(`⭐ Loaded ${userFavorites.size} favorites from server`);
      } catch(err) {
        console.error('loadUserFavorites error:', err);
        userFavorites = new Set();
      }
    }

    function updateHeader(){
      const hb = $('headerAuthButtons');
      if (currentUser && currentUser.id){
        hb.innerHTML = `
          <span style="color:var(--text-gray);margin-right:.5rem">Welcome, ${escapeHtml(currentUser.username || currentUser.email || 'User')}</span>
          <button id="logoutBtn" class="auth-btn">Logout</button>
        `;
        $('logoutBtn').addEventListener('click', async ()=>{ 
          await fetch('/api/logout',{method:'POST'}); 
          currentUser=null; 
          userFavorites=new Set(); 
          updateHeader(); 
          updateReviewFormVisibility();
          loadProducts(); 
        });
      } else {
        hb.innerHTML = `
          <button id="loginOpen" class="auth-btn">Login</button>
          <button id="signupOpen" class="auth-btn signup">Sign Up</button>
        `;
        // rebind newly created nodes
        $('loginOpen').addEventListener('click', ()=> openModal(loginModal));
        $('signupOpen').addEventListener('click', ()=> openModal(signupModal));
      }
      // show/hide seller view depending on sellerMode and login
      if (sellerMode && currentUser) {
        $('sellerView').classList.add('active');
      } else {
        $('sellerView').classList.remove('active');
      }
      $('sellerView').setAttribute('aria-hidden', !(sellerMode && currentUser));
      $('browseModeText').innerHTML = sellerMode ? 'Seller' : 'Buyer';
    }

    // ================= REVIEWS FUNCTIONS =================
    async function loadProductReviews(productId) {
      currentProductId = productId;

      try {
        const res = await fetch(`/api/reviews/${productId}`);
        const data = await res.json();

        const list = document.getElementById("reviewsList");
        const avg = document.getElementById("averageRating");

        if (!data.reviews || data.reviews.length === 0) {
          list.innerHTML = "<p style='color: var(--text-gray)'>No reviews yet.</p>";
          avg.textContent = "";
          return;
        }

        // Calculate average
        const avgRating =
          data.reviews.reduce((sum, r) => sum + r.rating, 0) /
          data.reviews.length;

        avg.textContent = `⭐ ${avgRating.toFixed(1)} / 5 (${data.count} reviews)`;

        list.innerHTML = data.reviews
          .map(
            r => `
            <div class="review-item">
              <strong>${escapeHtml(r.username)} — ⭐ ${r.rating}</strong>
              <p>${escapeHtml(r.comment)}</p>
              <small>${new Date(r.created_at).toLocaleDateString()}</small>
            </div>
          `
          )
          .join("");

      } catch (err) {
        console.error("Error loading reviews:", err);
        const list = document.getElementById("reviewsList");
        list.innerHTML = "<p style='color: var(--danger)'>Error loading reviews. Please try again.</p>";
      }
    }

    function updateReviewFormVisibility() {
      const form = document.getElementById("reviewFormWrapper");
      if (!form) return;

      if (currentUser) {
        form.classList.remove("hidden");
      } else {
        form.classList.add("hidden");
      }
    }

    async function submitReview() {
      const rating = document.getElementById("reviewRating").value;
      const comment = document.getElementById("reviewComment").value.trim();
      const msg = document.getElementById("reviewMessage");

      if (!rating || !comment) {
        msg.textContent = "Rating and comment required.";
        msg.style.color = "var(--danger)";
        return;
      }

      try {
        const res = await fetch("/api/reviews", {
          method: "POST",
          headers: { "Content-Type": "application/json", 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({
            productId: currentProductId,
            rating,
            comment
          })
        });

        const data = await res.json();

        if (!res.ok) {
          msg.textContent = data.error || "Failed to submit review.";
          msg.style.color = "var(--danger)";
          return;
        }

        msg.textContent = "Review submitted successfully!";
        msg.style.color = "var(--success)";

        document.getElementById("reviewComment").value = "";
        document.getElementById("reviewRating").value = "";

        // Reload reviews
        loadProductReviews(currentProductId);

      } catch (err) {
        console.error("Review submit error:", err);
        msg.textContent = "Network error. Please try again.";
        msg.style.color = "var(--danger)";
      }
    }

    // login form
    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      $('loginMsg').textContent = "";
      const useUsername = $('usernameGroup').style.display !== 'none';
      const payload = { password: $('loginPassword').value };
      if (useUsername) payload.username = $('loginUsername').value;
      else payload.email = $('loginEmail').value;

      try {
        const res = await fetch('/api/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) {
          $('loginMsg').innerHTML = `<div style="color:var(--danger);padding:8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">${escapeHtml(data.error || 'Login failed')}</div>`;
          return;
        }
        $('loginMsg').innerHTML = `<div style="color:var(--success);padding:8px;border-radius:var(--radius-sm);background:rgba(16,185,129,0.1);border-left:3px solid var(--success)">✅ ${escapeHtml(data.message || 'Logged in')}</div>`;
        await loadUser();
        await loadUserFavorites();
        closeModal(loginModal);
        if (sellerMode) $('sellerView').classList.add('active');
      } catch(err){
        console.error('login err',err);
        const message = handleApiError(err, 'Login');
        $('loginMsg').innerHTML = `<div style="color:var(--danger);padding:8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">${escapeHtml(message)}</div>`;
      }
    });

    // signup form (auto login if possible)
    $('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      $('signupMsg').textContent = "";
      const username = $('signupUsername').value.trim();
      const email = $('signupEmail').value.trim();
      const password = $('signupPassword').value;

      if (!username || !email || !password) { 
        $('signupMsg').innerHTML = `<div style="color:var(--danger);padding:8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">All fields required.</div>`; 
        return; 
      }

      try {
        const res = await fetch('/api/signup', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({username, email, password})
        });
        const data = await res.json();
        if (!res.ok) {
          $('signupMsg').innerHTML = `<div style="color:var(--danger);padding:8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">${escapeHtml(data.error || 'Signup failed')}</div>`;
          return;
        }

        $('signupMsg').innerHTML = `<div style="color:var(--success);padding:8px;border-radius:var(--radius-sm);background:rgba(16,185,129,0.1);border-left:3px solid var(--success)">${escapeHtml(data.message || 'Signup success')}<br/>Attempting to login...</div>`;

        // try auto-login
        const loginRes = await fetch('/api/login', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({ username, password })
        });

        if (loginRes.ok) {
          await loadUser();
          await loadUserFavorites();
          $('signupMsg').innerHTML = `<div style="color:var(--success);padding:8px;border-radius:var(--radius-sm);background:rgba(16,185,129,0.1);border-left:3px solid var(--success)">Signed up and logged in ✅</div>`;
          closeModal(signupModal);
        } else {
          const d = await loginRes.json().catch(()=>({}));
          $('signupMsg').innerHTML = `<div style="color:var(--success);padding:8px;border-radius:var(--radius-sm);background:rgba(16,185,129,0.1);border-left:3px solid var(--success)">${escapeHtml(data.message || 'Signup success')}. ${escapeHtml(d.error || '')}</div>`;
        }
      } catch(err){
        console.error('signup err',err);
        const message = handleApiError(err, 'Signup');
        $('signupMsg').innerHTML = `<div style="color:var(--danger);padding:8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.1);border-left:3px solid var(--danger)">${escapeHtml(message)}</div>`;
      }
    });

    function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    // ---------- Seller toggle ----------
    const becomeBtn = $('becomeSeller');
    becomeBtn.addEventListener('click', async ()=>{
      if (!currentUser){
        openModal(loginModal);
        return;
      }
      sellerMode = !sellerMode;
      becomeBtn.textContent = sellerMode ? 'Back to Buyer View' : 'Become a Seller';
      $('sellerView').classList.toggle('active', sellerMode);
      $('sellerView').setAttribute('aria-hidden', !sellerMode);
      $('browseModeText').innerHTML = sellerMode ? 'Seller' : 'Buyer';
      if (!sellerMode) window.scrollTo({top:200,behavior:'smooth'});
    });

    $('cancelSeller').addEventListener('click', ()=>{ 
      sellerMode=false; 
      becomeBtn.textContent='Become a Seller'; 
      $('sellerView').classList.remove('active'); 
      $('sellerView').setAttribute('aria-hidden','true'); 
      $('browseModeText').innerHTML = 'Buyer';
    });

    // ---------- Product type UI logic ----------
    $('p_type').addEventListener('change', (ev)=>{
      const v = ev.target.value;
      const digitalBlock = $('digitalBlock');
      const physicalBlock = $('physicalBlock');
      
      // Hide all
      digitalBlock.classList.remove('show');
      physicalBlock.classList.remove('show');
      
      // Show relevant section
      if (v === 'digital' || v === 'affiliate') {
        digitalBlock.classList.add('show');
      } else if (v === 'physical') {
        physicalBlock.classList.add('show');
        // Force Pay on Delivery for physical products
        $('p_paymentOption').value = 'pay_on_delivery';
      }
      
      // Handle affiliate checkbox visibility
      if (v === 'affiliate') {
        document.getElementById('useAffiliate').checked = true;
        toggleAffiliateFields();
        document.getElementById('digitalUpload').classList.remove('show');
      } else if (v === 'digital') {
        document.getElementById('useAffiliate').checked = false;
        toggleAffiliateFields();
        document.getElementById('digitalUpload').classList.add('show');
      }
    });

    $('useAffiliate').addEventListener('change',toggleAffiliateFields);

    $('p_deliveryType').addEventListener('change', (e)=>{ 
      const deliveryExtra = $('deliveryExtra');
      if (e.target.value === 'delivery') {
        deliveryExtra.classList.add('show');
      } else {
        deliveryExtra.classList.remove('show');
      }
    });

    // ---------- Fetch & render products ----------
    async function loadProducts(){
      try {
        showSkeletonLoader();
        const r = await fetch('/api/products');
        if (!r.ok) { products = []; renderProducts(); return; }
        products = await r.json() || [];
        products = products.map(p => {
          p.price = Number(p.price || 0);
          if (p.images && typeof p.images === 'string') {
            try { p.images = JSON.parse(p.images); } catch(e) {}
          }
          p._imageList = Array.isArray(p.images) && p.images.length ? p.images :
                         (p.file_path ? [p.file_path] : (p.image ? [p.image] : []));
          p._imageList = p._imageList.map(src=>{
            if (!src) return null;
            if (src.startsWith('/')) return src;
            if (src.startsWith('http')) return src;
            return '/'+src;
          }).filter(Boolean);
          p.rating = Number(p.rating||0);
          p.seller_name = p.seller_name || p.username || p.seller || 'Seller';
          p.type = p.type || p.product_type || (p._imageList.length && p.price>0 ? 'digital' : 'physical');
          if (p.category) categoriesSet.add(p.category);
          p.favorite_count = Number(p.favorite_count || p.favorites || 0);
          p.review_count = Number(p.review_count || p.reviews || 0);
          
          // Set default delivery type for physical products
          if (p.type === 'physical' && !p.delivery_type) {
            p.delivery_type = 'pickup';
          }
          
          return p;
        });
        populateCategoryFilter();
        renderProducts();
      } catch(err){
        console.error('loadProducts',err);
        products = [];
        renderProducts();
      }
    }

    function populateCategoryFilter(){
      const sel = $('filterCategory');
      const existing = new Set(Array.from(sel.options).map(o=>o.value));
      categoriesSet.forEach(cat=>{
        if (!existing.has(cat)) {
          const opt = document.createElement('option'); opt.value=cat; opt.textContent=cat; sel.appendChild(opt);
        }
      });
    }

    function renderProducts(){
      const grid = $('productsGrid');
      const q = $('searchInput').value.trim().toLowerCase();
      const typeFilter = $('filterType').value;
      const catFilter = $('filterCategory').value;
      const sort = $('sortSelect').value;

      let list = products.slice();

      if (q) list = list.filter(p => (p.title||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q));
      if (typeFilter) list = list.filter(p => (p.type||'').toLowerCase() === typeFilter);
      if (catFilter) list = list.filter(p => (p.category||'') === catFilter);

      if (sort === 'affordable') list.sort((a,b)=>a.price - b.price);
      else if (sort === 'rated') list.sort((a,b)=>b.rating - a.rating);
      else if (sort === 'favorites') list.sort((a,b)=>b.favorite_count - a.favorite_count);
      else list.sort((a,b)=> new Date(b.created_at || 0) - new Date(a.created_at || 0));

      if (!list.length) { 
        $('noProducts').style.display='block'; 
        grid.innerHTML=''; 
        return; 
      }
      $('noProducts').style.display='none';

      grid.innerHTML = list.map(p => {
        const img = p._imageList && p._imageList.length ? p._imageList[0] : 'https://via.placeholder.com/400x250?text=No+image';
        const thumbHtml = (p._imageList||[]).slice(0,3).map((t, idx)=>`<img src="${escapeHtml(t)}" alt="thumb${idx}" onclick="switchMainImage(${p.id}, ${idx})">`).join('');
        const seller = escapeHtml(p.seller_name || 'Seller');
        const title = escapeHtml(p.title || p.productName || p.name || 'Untitled');
        const desc = escapeHtml((p.description||'').slice(0,120));
        const price = fmtPrice(p.price);
        const isAffiliate = (p.type === 'affiliate' || p.type === 'affiliate_link' || p.affiliate_link);
        const isFavorite = userFavorites.has(p.id);
        const isPhysical = p.type === 'physical';
        const badgeClass = p.type === 'digital' ? 'badge-digital' : 
                          p.type === 'physical' ? 'badge-physical' : 
                          'badge-affiliate';

        // Delivery and payment info for physical products
        const deliveryInfo = isPhysical ? `
          <div class="product-details">
            <div class="detail-item">
              <i class="fas fa-truck"></i>
              <span><strong>Delivery:</strong> ${p.delivery_type === 'delivery' ? 'Home Delivery' : 'Customer Pickup'}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-money-bill-wave"></i>
              <span><strong>Payment:</strong> ${p.payment_option || 'Pay on Delivery'}</span>
            </div>
            ${p.delivery_type === 'delivery' && p.delivery_locations ? `
              <div class="detail-item">
                <i class="fas fa-map-marker-alt"></i>
                <span><strong>Locations:</strong> ${escapeHtml(p.delivery_locations)}</span>
              </div>
            ` : ''}
          </div>
        ` : '';

        // Badges for physical products
        const paymentBadge = isPhysical ? `<div class="payment-badge">${p.payment_option || 'Pay on Delivery'}</div>` : '';
        const deliveryBadge = isPhysical && p.delivery_type ? 
          `<div class="delivery-badge">${p.delivery_type === 'delivery' ? 'Home Delivery' : 'Pickup'}</div>` : '';

        return `
          <div class="product-card" data-id="${p.id}" data-user-id="${p.user_id}" onclick="selectProductForReviews(${p.id})">
            <div class="product-badge ${badgeClass}">${p.type || 'Product'}</div>
            ${paymentBadge}
            ${deliveryBadge}
            <div class="card-media">
              <img id="mainimg-${p.id}" src="${escapeHtml(img)}" alt="${title}" loading="lazy">
              ${p._imageList && p._imageList.length > 1 ? `<div class="thumbs">${thumbHtml}</div>` : ''}
              <button class="favorite-btn ${isFavorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite(${p.id})">
                <i class="fas fa-heart"></i>
              </button>
              <button class="delete-btn" onclick="event.stopPropagation(); deleteProduct(${p.id})" title="Delete Product">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="card-body">
              <h3>${title}</h3>
              <div class="seller-info">
                <i class="fas fa-user"></i>
                <span>By ${seller}</span>
              </div>
              <div class="meta">${desc}</div>
              ${deliveryInfo}
              <div class="rating">
                <span class="rating-stars">${'⭐'.repeat(Math.floor(p.rating))}</span>
                <span class="rating-count">(${p.review_count || 0})</span>
                <span style="color:var(--text-gray);margin-left:8px">• ${p.favorite_count || 0} favorites</span>
              </div>
              <div class="price-row">
                <div>
                  <div class="price">${price}</div>
                </div>
                <div class="card-actions">
                  ${ isAffiliate ? `
                    <button class="small-btn primary" onclick="event.stopPropagation(); openAffiliate('${escapeHtml(p.affiliate_link||p.external_link||'')}')">
                      <i class="fas fa-external-link-alt"></i> Visit
                    </button>
                  ` : isPhysical ? `
                    <button class="small-btn success" onclick="event.stopPropagation(); orderPhysicalProduct(${p.id})">
                      <i class="fas fa-shopping-cart"></i> Order Now
                    </button>
                  ` : `
                    <button class="small-btn primary" onclick="event.stopPropagation(); buyProduct(${p.id})">
                      <i class="fas fa-shopping-cart"></i> Buy Now
                    </button>
                  `}
                  <button class="small-btn" onclick="event.stopPropagation(); selectProductForReviews(${p.id})">
                    <i class="fas fa-eye"></i> View
                  </button>
                </div>
              </div>
              <div class="owner-controls">
                <button class="small-btn" onclick="event.stopPropagation(); editProduct(${p.id})">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="small-btn danger" onclick="event.stopPropagation(); deleteProduct(${p.id})">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Initialize product ownership after rendering
      initializeProductOwnership();
      startProductCarousels();
    }

    // Function to select product for reviews
    function selectProductForReviews(productId) {
      currentProductId = productId;
      loadProductReviews(productId);
      // Scroll to reviews section
      document.getElementById('productReviewsSection').scrollIntoView({ behavior: 'smooth' });
    }

    window.switchMainImage = function(productId, thumbIndex){
      const prod = products.find(p=>p.id == productId);
      if (!prod || !prod._imageList || !prod._imageList[thumbIndex]) return;
      const main = $('mainimg-'+productId);
      if (main) main.src = prod._imageList[thumbIndex];
    };

    window.openAffiliate = function(url){
      if (!url) { alert('No affiliate url provided'); return; }
      window.open(url,'_blank');
    };

    // --- product image carousel manager ---
    const productImageIntervals = new Map(); // productId -> intervalId

    function startProductCarousels() {
      // Keep track of product cards currently displayed
      const currentIds = new Set();

      document.querySelectorAll('.product-card').forEach(card => {
        const id = card.getAttribute('data-id');
        if (!id) return;
        currentIds.add(String(id));

        // find product in the global products array
        const prod = products.find(p => String(p.id) === String(id));
        if (!prod || !Array.isArray(prod._imageList) || prod._imageList.length === 0) return;

        const mainImg = document.getElementById(`mainimg-${id}`);
        // ensure first image shows right away
        if (mainImg) mainImg.src = prod._imageList[0];

        // if only one image, no need to set an interval
        if (prod._imageList.length <= 1) {
          // clear any old interval if present
          if (productImageIntervals.has(id)) {
            clearInterval(productImageIntervals.get(id));
            productImageIntervals.delete(id);
          }
          return;
        }

        // if an interval already exists for this product, skip
        if (productImageIntervals.has(id)) return;

        // create interval to rotate images
        let idx = 0;
        const iv = setInterval(() => {
          idx = (idx + 1) % prod._imageList.length;
          const imgEl = document.getElementById(`mainimg-${id}`);
          if (imgEl) imgEl.src = prod._imageList[idx];
        }, 2500); // change delay as you prefer (ms)

        productImageIntervals.set(id, iv);

        // Optional: pause on hover and resume on leave
        card.querySelector('.card-media')?.addEventListener('mouseenter', () => {
          const ivId = productImageIntervals.get(id);
          if (ivId) { clearInterval(ivId); productImageIntervals.delete(id); }
        });
        card.querySelector('.card-media')?.addEventListener('mouseleave', () => {
          // prevent creating duplicate intervals
          if (productImageIntervals.has(id)) return;
          let idx2 = prod._imageList.indexOf((document.getElementById(`mainimg-${id}`)?.src) || '') ;
          if (idx2 < 0) idx2 = 0;
          const iv2 = setInterval(() => {
            idx2 = (idx2 + 1) % prod._imageList.length;
            const el = document.getElementById(`mainimg-${id}`);
            if (el) el.src = prod._imageList[idx2];
          }, 2500);
          productImageIntervals.set(id, iv2);
        });
      });

      // Clear intervals for product cards that were removed from DOM
      for (const [pid, iv] of productImageIntervals.entries()) {
        if (!currentIds.has(String(pid))) {
          clearInterval(iv);
          productImageIntervals.delete(pid);
        }
      }
    }

   // ---------- Favorites ----------
    async function toggleFavorite(productId) {
      if (!currentUser) { 
        openModal(loginModal); 
        return; 
      }
      
      try {
        const favoriteBtn = document.querySelector(`.favorite-btn[onclick*="toggleFavorite(${productId})"]`);
        const heartIcon = favoriteBtn?.querySelector('i');
        
        // Show immediate visual feedback
        if (heartIcon) {
          heartIcon.style.transform = 'scale(1.3)';
          setTimeout(() => { heartIcon.style.transform = 'scale(1)'; }, 200);
        }

        const response = await fetch('/api/favorites', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({ productId })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update local favorites set
          if (data.action === 'added') {
            userFavorites.add(productId);
            if (heartIcon) heartIcon.classList.add('active');
          } else {
            userFavorites.delete(productId);
            if (heartIcon) heartIcon.classList.remove('active');
          }
          
          // Update the product favorite count
          const product = products.find(p => p.id === productId);
          if (product) {
            product.favorite_count = data.action === 'added' 
              ? (product.favorite_count || 0) + 1 
              : Math.max(0, (product.favorite_count || 1) - 1);
          }
          
          // Re-render to update counts and heart icons
          renderProducts();
          
          console.log(`⭐ Favorite ${data.action}: Product ${productId}`);
        } else {
          const error = await response.json();
          alert(error.error || 'Failed to update favorites');
        }
      } catch(error) {
        console.error('Favorite toggle failed:', error);
        const message = handleApiError(error, 'Update favorites');
        alert(message);
      }
    }
    window.toggleFavorite = toggleFavorite;

    // ---------- Buy Digital Product ----------
    async function buyProduct(productId){
      try {
        const meR = await fetch('/api/me'); const me = await meR.json();
        if (!me || !me.id) { openModal(loginModal); return; }
        const res = await fetch('/api/buy-product', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({ productId })
        });
        const data = await res.json();
        if (!res.ok) { alert(data.error || 'Error initiating purchase'); return; }
        const link = data.link || data.paymentLink || data.payment_link;
        if (link) window.location.href = link;
        else alert('Payment link not returned by server.');
      } catch(err){
        console.error('buyProduct',err);
        const message = handleApiError(err, 'Purchase');
        alert(message);
      }
    }
    window.buyProduct = buyProduct;

    // ---------- Delete (admin or owner) ----------
    async function deleteProduct(id){
      if (!confirm('Are you sure you want to delete this product? This cannot be undone.')) return;
      try {
        const res = await fetch(`/api/products/${id}`, { method:'DELETE', headers:{ 'X-CSRF-Token': getCSRFToken() } });
        if (res.ok) { 
          await loadProducts(); 
          // Also remove from favorites if present
          userFavorites.delete(id);
        }
        else {
          const d = await res.json();
          alert(d.error || 'Failed to delete');
        }
      } catch(err){
        console.error('deleteProduct',err);
        const message = handleApiError(err, 'Delete product');
        alert(message);
      }
    }
    window.deleteProduct = deleteProduct;

    // ---------- Edit Product ----------
    async function editProduct(productId){
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      // Switch to seller view
      sellerMode = true;
      $('sellerView').classList.add('active');
      $('browseModeText').innerHTML = 'Seller';
      becomeBtn.textContent = 'Back to Buyer View';
      
      // Populate form with product data
      document.getElementById('p_title').value = product.title || '';
      document.getElementById('p_description').value = product.description || '';
      document.getElementById('p_price').value = product.price || '';
      document.getElementById('p_type').value = product.type || '';
      
      // Set category
      if (product.category) {
        const categorySelect = document.getElementById('p_category_select');
        const existingOption = Array.from(categorySelect.options).find(opt => opt.value === product.category);
        if (existingOption) {
          categorySelect.value = product.category;
        } else {
          document.getElementById('p_category_new').value = product.category;
        }
      }
      
      // Trigger type change to show appropriate sections
      document.getElementById('p_type').dispatchEvent(new Event('change'));
      
      // Set delivery type for physical products
      if (product.type === 'physical') {
        document.getElementById('p_deliveryType').value = product.delivery_type || 'pickup';
        document.getElementById('p_deliveryType').dispatchEvent(new Event('change'));
        
        if (product.delivery_type === 'delivery') {
          document.getElementById('p_deliveryLocations').value = product.delivery_locations || '';
          document.getElementById('p_deliveryFee').value = product.delivery_fee || '';
          document.getElementById('p_paymentOption').value = product.payment_option || 'pay_on_delivery';
        }
      }
      
      // Scroll to form
      $('sellerView').scrollIntoView({ behavior: 'smooth' });
    }
    window.editProduct = editProduct;

    // ========== UPLOAD PRODUCT FUNCTION ==========
    $('uploadProductBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      console.log("🟢 Upload button CLICKED!");

      // Validate form first
      if (!validateProductForm()) {
        console.log("❌ Form validation failed");
        return;
      }

      // Check if user is logged in
      if (!currentUser){ 
        console.log("❌ No user - opening login modal");
        openModal(loginModal); 
        return; 
      }
      console.log("✅ User is logged in:", currentUser.id);

      // Get form values
      const title = $('p_title').value.trim();
      const description = $('p_description').value.trim();
      const category = getSelectedCategory();
      const price = $('p_price').value || 0;
      const type = $('p_type').value;
      const paymentProvider = $('p_paymentProvider').value;
      
      console.log("📦 Form values:", { title, description, category, price, type, paymentProvider });

      const fd = new FormData();
      fd.append('title', title);
      fd.append('description', description);
      fd.append('category', category);
      fd.append('price', price);
      fd.append('type', type);
      fd.append('paymentProvider', paymentProvider);

      // Digital / affiliate
      if (type === 'affiliate' || document.getElementById('useAffiliate').checked) {
        const aff = $('p_affiliate').value.trim();
        console.log("🔗 Affiliate link:", aff);
        fd.append('affiliate_link', aff);
      } else if (type === 'digital') {
        const file = $('p_file').files[0];
        console.log("💾 Digital file:", file);
        if (file) fd.append('file', file);
      }

      // Physical products
      if (type === 'physical') {
        const deliveryType = $('p_deliveryType').value;
        fd.append('delivery_type', deliveryType);
        // Default to Pay on Delivery for physical products
        fd.append('payment_option', $('p_paymentOption').value || 'pay_on_delivery');
        
        console.log("📦 Physical product delivery:", deliveryType);
        if (deliveryType === 'delivery') {
          fd.append('delivery_locations', $('p_deliveryLocations').value.trim());
          fd.append('delivery_fee', $('p_deliveryFee').value || 0);
        }
      }

      // Business information
      fd.append('businessName', $('p_businessName').value.trim());
      fd.append('businessEmail', $('p_businessEmail').value.trim());
      fd.append('businessPhone', $('p_businessPhone').value.trim());
      fd.append('country', $('p_country').value.trim());
      fd.append('bankName', $('p_bankName').value.trim());
      fd.append('bankCode', $('p_bankCode').value.trim());
      fd.append('accountNumber', $('p_accountNumber').value.trim());
      fd.append('accountName', $('p_accountName').value.trim());

      // Multiple images
      const images = $('p_images').files;
      console.log("🖼️ Images:", images.length);
      if (images && images.length) {
        for (let i = 0; i < images.length; i++) {
          fd.append('images[]', images[i]);
        }
      }

      // Debug FormData
      console.log("📤 FormData contents:");
      for (let pair of fd.entries()) {
        console.log(`${pair[0]}:`, pair[1]);
      }

      $('uploadMessage').innerHTML = '<div class="form-success" style="color:var(--text-gray)">Uploading product...</div>';
      $('uploadMessage').classList.add('show');

      try {
        console.log("🚀 Sending request to /api/upload-product...");
        const res = await fetch('/api/upload-product', { 
          method: 'POST', 
          body: fd 
        });
        
        console.log("📨 Response status:", res.status);
        const data = await res.json();
        console.log("📨 Response data:", data);

        if (!res.ok) { 
          console.log("❌ Upload failed:", data.error);
          $('uploadMessage').innerHTML = `<div class="form-success" style="color:var(--danger)">${escapeHtml(data.error || 'Upload failed')}</div>`; 
          return; 
        }

        console.log("✅ Upload successful!");
        $('uploadMessage').innerHTML = `<div class="form-success" style="color:var(--success)">✅ Product uploaded successfully!</div>`;

        // Reset form
        document.querySelectorAll('#sellerView input, #sellerView textarea, #sellerView select').forEach(element => {
          if (element.type !== 'button' && element.id !== 'uploadProductBtn') {
            element.value = '';
          }
        });

        // Reset checkboxes
        $('useAffiliate').checked = false;
        toggleAffiliateFields();

        // Reset provider selection
        document.querySelectorAll('.provider-option').forEach(opt => opt.classList.remove('selected'));
        $('p_paymentProvider').value = '';
        document.getElementById('businessInfo').classList.remove('show');

        // Hide conditional sections
        document.getElementById('digitalBlock').classList.remove('show');
        document.getElementById('physicalBlock').classList.remove('show');
        document.getElementById('deliveryExtra').classList.remove('show');

        setTimeout(async () => {
          sellerMode = false; 
          becomeBtn.textContent = 'Become a Seller'; 
          $('sellerView').classList.remove('active');
          $('uploadMessage').classList.remove('show');
          await loadProducts();
        }, 3000);

      } catch(err) {
        console.error('❌ Upload error:', err);
        const message = handleApiError(err, 'Upload product');
        $('uploadMessage').innerHTML = `<div class="form-success" style="color:var(--danger)">${escapeHtml(message)}</div>`;
      }
    });

    // Save as draft button
    document.getElementById('saveDraftBtn')?.addEventListener('click', function(e) {
      e.preventDefault();
      alert('Draft saved! (This would save your progress in a real implementation)');
    });

    // Initialize categories dropdown
    function initializeCategories() {
      const categorySelect = $('p_category_select');
      const existingCategories = Array.from(categorySelect.options).map(opt => opt.value);
      
      // Add categories from our global set
      categoriesSet.forEach(category => {
        if (category && !existingCategories.includes(category)) {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        }
      });
    }

    // ---------- Search / sort / filters ----------
    $('searchInput').addEventListener('input', debounce(renderProducts, 250));
    $('filterType').addEventListener('change', renderProducts);
    $('filterCategory').addEventListener('change', renderProducts);
    $('sortSelect').addEventListener('change', renderProducts);
    $('refreshBtn').addEventListener('click', ()=> loadProducts());

    function debounce(fn, ms=300){
      let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
    }

    // ---------- Currency selector ----------
    const currencySelect = $('currencyHeader');
    currencySelect.value = currentCurrency;
    currencySelect.addEventListener('change', (e)=>{
      currentCurrency = e.target.value;
      localStorage.setItem('ci_currency', currentCurrency);
      renderProducts();
    });

    // ---------- Initial load ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadUser();
      await loadUserFavorites();
      await loadProducts();
      initializeCategories();
      
      // Load reviews for first product if available
      if (products.length > 0) {
        currentProductId = products[0].id;
        loadProductReviews(currentProductId);
      }
    });
  </script>
</body>
</html>